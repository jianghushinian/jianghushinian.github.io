<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>万字解析 Go 官方结构体化日志包 slog | 江湖十年 | 学而不思则罔，思而不学则殆。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Log,Go">
    <meta name="description" content="slog 日志包是 Go 语言中的一个结构化日志库，旨在提供一个简单而强大的日志系统。因为标准日志库 log 过于简陋，社区中经常有人吐槽，Go 官方也承认了这一点，于是 Go 团队成员 Jonathan Amsterdam 操刀设计了新的日志库 slog，其放在 log&#x2F;slog 目录中。 slog 设计之初大量参考了社区中现有日志包方案，相比于 log，主要解决了两个问题：  log 不支持日">
<meta property="og:type" content="article">
<meta property="og:title" content="万字解析 Go 官方结构体化日志包 slog">
<meta property="og:url" content="http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/index.html">
<meta property="og:site_name" content="江湖十年">
<meta property="og:description" content="slog 日志包是 Go 语言中的一个结构化日志库，旨在提供一个简单而强大的日志系统。因为标准日志库 log 过于简陋，社区中经常有人吐槽，Go 官方也承认了这一点，于是 Go 团队成员 Jonathan Amsterdam 操刀设计了新的日志库 slog，其放在 log&#x2F;slog 目录中。 slog 设计之初大量参考了社区中现有日志包方案，相比于 log，主要解决了两个问题：  log 不支持日">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/slog.png">
<meta property="og:image" content="http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/slog-record.png">
<meta property="article:published_time" content="2024-06-24T00:29:52.000Z">
<meta property="article:modified_time" content="2024-06-24T01:44:27.853Z">
<meta property="article:author" content="江湖十年">
<meta property="article:tag" content="Log">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/slog.png">
    
        <link rel="alternate" type="application/atom+xml" title="江湖十年" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">江湖十年</h5>
          <a href="mailto:jianghushinian007@outlook.com" title="jianghushinian007@outlook.com" class="mail">jianghushinian007@outlook.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-link"></i>
                关于
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/jianghushinian" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">万字解析 Go 官方结构体化日志包 slog</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">万字解析 Go 官方结构体化日志包 slog</h1>
        <h5 class="subtitle">
            
                <time datetime="2024-06-24T00:29:52.000Z" itemprop="datePublished" class="page-time">
  2024-06-24
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Go/">Go</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#slog-快速入门"><span class="post-toc-number">1.</span> <span class="post-toc-text">slog 快速入门</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#快速开始"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">快速开始</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#附加属性"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">附加属性</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Context-版本日志方法"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Context 版本日志方法</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#修改日志级别"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">修改日志级别</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#获取当前日志级别"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">获取当前日志级别</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#结构化日志"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">结构化日志</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#JSONHandler"><span class="post-toc-number">1.6.1.</span> <span class="post-toc-text">JSONHandler</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#TextHandler"><span class="post-toc-number">1.6.2.</span> <span class="post-toc-text">TextHandler</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用自定义-logger-替换默认-logger"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">使用自定义 logger 替换默认 logger</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#将-slog-Logger-转换为-log-Logger"><span class="post-toc-number">1.8.</span> <span class="post-toc-text">将 slog.Logger 转换为 log.Logger</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用宽松类型可能出现不匹配的属性键值对"><span class="post-toc-number">1.9.</span> <span class="post-toc-text">使用宽松类型可能出现不匹配的属性键值对</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用强类型缓解可能出现不匹配的属性键值对"><span class="post-toc-number">1.10.</span> <span class="post-toc-text">使用强类型缓解可能出现不匹配的属性键值对</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#利用-LogAttrs-限制必须使用强类型，避免出现-BADKEY"><span class="post-toc-number">1.11.</span> <span class="post-toc-text">利用 LogAttrs 限制必须使用强类型，避免出现 !BADKEY</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#属性分组"><span class="post-toc-number">1.12.</span> <span class="post-toc-text">属性分组</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#JSONHandler-1"><span class="post-toc-number">1.12.1.</span> <span class="post-toc-text">JSONHandler</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#TextHandler-1"><span class="post-toc-number">1.12.2.</span> <span class="post-toc-text">TextHandler</span></a></li></ol></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用子-logger"><span class="post-toc-number">1.13.</span> <span class="post-toc-text">使用子 logger</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#为子-logger-属性分组"><span class="post-toc-number">1.14.</span> <span class="post-toc-text">为子 logger 属性分组</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#实现-slog-LogValuer-接口，隐藏敏感信息"><span class="post-toc-number">1.15.</span> <span class="post-toc-text">实现 slog.LogValuer 接口，隐藏敏感信息</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#slog-是如何设计的"><span class="post-toc-number">2.</span> <span class="post-toc-text">slog 是如何设计的</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#定制-Logger"><span class="post-toc-number">3.</span> <span class="post-toc-text">定制 Logger</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#自定义日志级别"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">自定义日志级别</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#动态设置日志级别"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">动态设置日志级别</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#设置-caller-skip"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">设置 caller skip</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#完整-Logger-代码实现"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">完整 Logger 代码实现</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#自定义-Handler"><span class="post-toc-number">4.</span> <span class="post-toc-text">自定义 Handler</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#总结"><span class="post-toc-number">5.</span> <span class="post-toc-text">总结</span></a></li></ol>
        </nav>
    </aside>


<article id="post-go-s-official-structured-log-package-slog"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">万字解析 Go 官方结构体化日志包 slog</h1>
        <div class="post-meta">
            <time class="post-time" title="2024-06-24 08:29:52" datetime="2024-06-24T00:29:52.000Z"  itemprop="datePublished">2024-06-24</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Go/">Go</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>slog 日志包是 Go 语言中的一个结构化日志库，旨在提供一个简单而强大的日志系统。因为标准日志库 <code>log</code> 过于简陋，社区中经常有人吐槽，Go 官方也承认了这一点，于是 Go 团队成员 <a href="https://github.com/jba" target="_blank" rel="noopener">Jonathan Amsterdam</a> 操刀设计了新的日志库 slog，其放在 <code>log/slog</code> 目录中。</p>
<p>slog 设计之初大量参考了社区中现有日志包方案，相比于 <code>log</code>，主要解决了两个问题：</p>
<ul>
<li><code>log</code> 不支持日志级别。</li>
<li><code>log</code> 日志不是结构化的。</li>
</ul>
<p>这两个问题都能在 slog 中得到解决，本文就来带大家详解 slog 用法及设计。</p>
<a id="more"></a>

<blockquote>
<p>NOTE:<br>如果你对标准库 log 不够熟悉，可以参考我的文章：<a href="https://jianghushinian.cn/2023/03/11/dive-into-the-go-log-standard-library/" target="_blank" rel="noopener">《深入探究 Go log 标准库》</a>。</p>
</blockquote>
<h3 id="slog-快速入门"><a href="#slog-快速入门" class="headerlink" title="slog 快速入门"></a>slog 快速入门</h3><h4 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h4><p>slog 使用非常简单，导入 <code>log/slog</code> 后即可使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"log/slog"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	slog.Debug(<span class="string">"debug message"</span>)</span><br><span class="line">	slog.Info(<span class="string">"info message"</span>)</span><br><span class="line">	slog.Warn(<span class="string">"warn message"</span>)</span><br><span class="line">	slog.Error(<span class="string">"error message"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">2024/06/23 10:20:38 INFO info message</span><br><span class="line">2024/06/23 10:20:38 WARN warn message</span><br><span class="line">2024/06/23 10:20:38 ERROR error message</span><br></pre></td></tr></table></figure>

<p>slog 日志默认输出到 <code>os.Stdout</code>。</p>
<p>可以发现 <code>Debug</code> 日志并没有输出，说明 slog 日志默认级别为 <code>Info</code>。</p>
<p>slog 默认仅支持 <code>Debug</code>、<code>Info</code>、<code>Warn</code>、<code>Error</code> 这 4 种日志级别，后文会演示如何增加自定义日志级别。</p>
<h4 id="附加属性"><a href="#附加属性" class="headerlink" title="附加属性"></a>附加属性</h4><p>slog 支持在 <code>msg</code> 后传入无限多个 <code>key/value</code> 键值对来附加额外的属性：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slog.Debug(<span class="string">"debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.Info(<span class="string">"info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.Warn(<span class="string">"warn message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.Error(<span class="string">"error message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">2024/06/23 10:21:33 INFO info message hello=world</span><br><span class="line">2024/06/23 10:21:33 WARN warn message hello=world</span><br><span class="line">2024/06/23 10:21:33 ERROR error message hello=world</span><br></pre></td></tr></table></figure>

<p>可以发现，传递给日志方法的键值对会以 <code>key=value</code> 格式输出。</p>
<h4 id="Context-版本日志方法"><a href="#Context-版本日志方法" class="headerlink" title="Context 版本日志方法"></a>Context 版本日志方法</h4><p>slog 的日志方法都存在 <code>XxxContext</code> 版本，使用示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx := context.Background()</span><br><span class="line">slog.DebugContext(ctx, <span class="string">"debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.InfoContext(ctx, <span class="string">"info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.WarnContext(ctx, <span class="string">"warn message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.ErrorContext(ctx, <span class="string">"error message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">2024/06/23 10:22:29 INFO info message hello=world</span><br><span class="line">2024/06/23 10:22:29 WARN warn message hello=world</span><br><span class="line">2024/06/23 10:22:29 ERROR error message hello=world</span><br></pre></td></tr></table></figure>

<p>输出结果与不使用 <code>Context</code> 版本的日志方法相同。</p>
<p>事实上，它们的代码主逻辑是一样的：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Info calls [Logger.Info] on the default logger.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Info</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	Default().log(context.Background(), LevelInfo, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// InfoContext calls [Logger.InfoContext] on the default logger.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InfoContext</span><span class="params">(ctx context.Context, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	Default().log(ctx, LevelInfo, msg, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>无论是 <code>Xxx</code> 还是 <code>XxxContext</code> 版本的日志方法，底层都会调用 <code>slog.Logger.log</code> 方法，只不过 <code>Xxx</code> 日志方法的 <code>context</code> 是在方法内部构造的，<code>XxxContext</code> 日志方法的 <code>context</code> 是通过参数传入的。</p>
<h4 id="修改日志级别"><a href="#修改日志级别" class="headerlink" title="修改日志级别"></a>修改日志级别</h4><p>我们可以将 slog 日志级别修改为 <code>Debug</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">slog.SetLogLoggerLevel(slog.LevelDebug)</span><br><span class="line">slog.Debug(<span class="string">"debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.Info(<span class="string">"info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.Warn(<span class="string">"warn message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">slog.Error(<span class="string">"error message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">2024/06/23 10:23:31 DEBUG debug message hello=world</span><br><span class="line">2024/06/23 10:23:31 INFO info message hello=world</span><br><span class="line">2024/06/23 10:23:31 WARN warn message hello=world</span><br><span class="line">2024/06/23 10:23:31 ERROR error message hello=world</span><br></pre></td></tr></table></figure>

<p>可以发现，slog 修改日志级别还是非常方便的。</p>
<h4 id="获取当前日志级别"><a href="#获取当前日志级别" class="headerlink" title="获取当前日志级别"></a>获取当前日志级别</h4><p>既然可以修改日志级别，那么我们是否也可以获取当前日志级别呢？</p>
<p>很遗憾，slog 没有为我们提供一个方法可以便捷的获取日志级别。</p>
<p>不过，slog 的 <code>Logger</code> 对象有一个 <code>Enabled</code> 方法，可以用来判断给定的日志级别是否被开启。</p>
<p>那么我们就可以将日志级别由低到高依次传给 <code>Enabled</code> 方法来判断当前日志级别是否启用，只要当前日志级别已经启用，就说明 slog 开启的最低日志级别是当前日志级别。</p>
<p>示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> currentLevel slog.Level = <span class="number">-10</span></span><br><span class="line"><span class="keyword">for</span> _, level := <span class="keyword">range</span> []slog.Level&#123;slog.LevelDebug, slog.LevelInfo, slog.LevelWarn, slog.LevelError&#125; &#123;</span><br><span class="line">	r := slog.Default().Enabled(context.Background(), level)</span><br><span class="line">	<span class="keyword">if</span> r &#123;</span><br><span class="line">		currentLevel = level</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"current log level: %v\n"</span>, currentLevel)</span><br></pre></td></tr></table></figure>

<p>代码中初始化 <code>currentLevel</code> 用来记录当前日志级别，类型为 <code>slog.Level</code>，初始值为 <code>-10</code>。这之所以能生效，是因为其实 <code>slog.Level</code> 本身就是 <code>int</code> 类型。</p>
<p>slog 默认支持的几种日志级别定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Level <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LevelDebug Level = <span class="number">-4</span></span><br><span class="line">	LevelInfo  Level = <span class="number">0</span></span><br><span class="line">	LevelWarn  Level = <span class="number">4</span></span><br><span class="line">	LevelError Level = <span class="number">8</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>可以发现这几个日志级别并不是连续的，这是 slog 团队经过深思熟虑后的结果。故意这样设计，是为了方便我们增加自定义日志级别。使我们可以在任意两个日志级别之间定义自己的日志级别（后文会有讲解）。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">current <span class="built_in">log</span> level: DEBUG</span><br></pre></td></tr></table></figure>

<p><code>currentLevel</code> 初始值为 <code>-10</code> 而不是最低的日志级别 <code>LevelDebug</code>，可以证明这段获取当前日志级别的示例代码的确是有效的，而不是因为默认值设为 <code>LevelDebug</code> 打印结果才是 <code>DEBUG</code>。</p>
<h4 id="结构化日志"><a href="#结构化日志" class="headerlink" title="结构化日志"></a>结构化日志</h4><p>虽然我们说 slog 是结构化的日志包，但其实前文示例中打印的日志结果，并不是结构化的。</p>
<p>接下来看看 slog 支持的真正结构化日志输出长什么样。</p>
<h5 id="JSONHandler"><a href="#JSONHandler" class="headerlink" title="JSONHandler"></a>JSONHandler</h5><p>slog 支持 JSON 结构化日志。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line">l.Debug(<span class="string">"debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>我们可以通过 <code>slog.New</code> 方法创建一个自定义的 <code>*slog.Logger</code>。</p>
<p><code>slog.New</code> 接收一个 <code>slog.Handler</code> 对象（<code>slog.Handler</code> 是一个接口，后文会详细讲解）。</p>
<p>slog 内置了两个 <code>slog.Handler</code> 对象，其中一个就是 <code>*slog.JSONHandler</code>，可以使用 <code>slog.NewJSONHandler</code> 来创建。</p>
<p><code>slog.NewJSONHandler</code> 接收两个参数，传入的 <code>os.Stdout</code> 是一个 <code>io.Writer</code> 接口，用来指定日志输出位置。</p>
<p><code>*slog.HandlerOptions</code> 是一个结构体，<code>AddSource</code> 设为 <code>true</code> 可以输出记录日志的位置，<code>Level</code> 用来指定日志级别，<code>ReplaceAttr</code> 属性后文再来讲解。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:25:34.880089+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"DEBUG"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 71</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"debug message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NOTE:<br>slog 默认输出的 JSON 格式日志是没有换行和缩进的，例如：<br><code>{&quot;time&quot;:&quot;2024-06-23T10:25:34.880089+08:00&quot;,&quot;level&quot;:&quot;DEBUG&quot;,&quot;source&quot;:{&quot;function&quot;:&quot;main.main&quot;,&quot;file&quot;:&quot;/workspace/projects/blog-go-example/log/slog/main.go&quot;,&quot;line&quot;:71},&quot;msg&quot;:&quot;debug message&quot;,&quot;hello&quot;:&quot;world&quot;}</code><br>为了展示效果更佳清晰，这里输出的 JSON 格式日志是我经过美化处理的。后文示例也会如此。</p>
</blockquote>
<p>这就是 JSON 格式的结构化日志输出。</p>
<h5 id="TextHandler"><a href="#TextHandler" class="headerlink" title="TextHandler"></a>TextHandler</h5><p>slog 内置的另一个 <code>slog.Handler</code> 对象是 <code>*slog.TextHandler</code>，可以将日志输出为 <code>key=value</code> 结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewTextHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line">l.Debug(<span class="string">"debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">time=2024-06-23T10:25:34.880+08:00 level=DEBUG <span class="built_in">source</span>=/workspace/projects/blog-go-example/<span class="built_in">log</span>/slog/main.go:80 msg=<span class="string">"debug message"</span> hello=world</span><br></pre></td></tr></table></figure>

<p>一般来说，<code>TextHandler</code> 可以作为<code>开发/测试</code>环境的日志输出格式，方便查看；<code>JSONHandler</code> 可以作为<code>生产</code>环境的日志输出格式，方便日志工具采集。</p>
<blockquote>
<p>NOTE:<br>程序中可以通过环境变量来获取当前程序所处环境是开发、测试还是生产，以此来决定使用哪个 <code>Handler</code>。</p>
</blockquote>
<h4 id="使用自定义-logger-替换默认-logger"><a href="#使用自定义-logger-替换默认-logger" class="headerlink" title="使用自定义 logger 替换默认 logger"></a>使用自定义 logger 替换默认 logger</h4><p>前文已经演示了如何通过 <code>slog.New</code> 方法创建一个自定义的 <code>*slog.Logger</code>。</p>
<p>我们可以使用自定义的 <code>logger</code> 来替换掉 slog 默认的 <code>logger</code> 对象，方便使用。</p>
<p>示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">slog.Info(<span class="string">"info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">log.Println(<span class="string">"normal log"</span>)</span><br><span class="line"></span><br><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line">slog.SetDefault(l)</span><br><span class="line"></span><br><span class="line">slog.Info(<span class="string">"info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line"><span class="comment">// log 也被修改了</span></span><br><span class="line">log.Println(<span class="string">"normal log"</span>)</span><br></pre></td></tr></table></figure>

<p>使用 <code>slog.SetDefault(l)</code> 可以非常方便的用自定义的 <code>*slog.Logger</code> 对象 <code>l</code> 取代默认 <code>logger</code> 对象。</p>
<p>然后就可以像使用默认 <code>logger</code> 一样调用 <code>slog.Info</code> 使用自定义 <code>*slog.Logger</code> 记录日志了。</p>
<p>并且，<code>slog.SetDefault(l)</code> 对 <code>log</code> 库同样生效。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:27:18.946947+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 95</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:27:18.946957+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"DEBUG"</span>,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"normal log"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NOTE:<br>这里 <code>log.Println(&quot;normal log&quot;)</code> 输出的 JSON 日志也是经过美化处理的。</p>
</blockquote>
<h4 id="将-slog-Logger-转换为-log-Logger"><a href="#将-slog-Logger-转换为-log-Logger" class="headerlink" title="将 slog.Logger 转换为 log.Logger"></a>将 slog.Logger 转换为 log.Logger</h4><p>既然 <code>slog.SetDefault(l)</code> 对 <code>log</code> 库有影响，则说明 <code>*slog.Logger</code> 对象可以被转换成 <code>*log.Logger</code> 对象。</p>
<p>转换示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">logLogger := slog.NewLogLogger(l.Handler(), slog.LevelInfo)</span><br><span class="line">logLogger.Println(<span class="string">"normal log"</span>) <span class="comment">// 输出日志级别跟随 slog.LevelInfo 设置</span></span><br></pre></td></tr></table></figure>

<p><code>slog.NewLogLogger</code> 可以创建一个 <code>*log.Logger</code> 对象，而它的参数分别是 <code>slog.Handler</code> 对象和日志级别。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:30:07.99423+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 109</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"normal log"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，通过标准库 <code>*log.Logger</code> 对象 <code>logLogger</code> 输出的日志依然是 JSON 格式。</p>
<h4 id="使用宽松类型可能出现不匹配的属性键值对"><a href="#使用宽松类型可能出现不匹配的属性键值对" class="headerlink" title="使用宽松类型可能出现不匹配的属性键值对"></a>使用宽松类型可能出现不匹配的属性键值对</h4><p>前文有介绍 slog 支持在 <code>msg</code> 后传入无限多个 <code>key/value</code> 键值对来附加额外的属性。</p>
<p>但是，<strong>这里存在一个坑！</strong>如果 <code>key/value</code> 不是成对出现，则输出日志会得到意想不到的结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">l.Info(<span class="string">"info message"</span>, <span class="string">"hello"</span>) <span class="comment">// "!BADKEY":"hello"</span></span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:30:53.200792+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 120</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"!BADKEY"</span>: <span class="string">"hello"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例中除了 <code>msg</code> 外，仅存在一个为 <code>hello</code> 的 <code>key</code>，并没有传入对应的 <code>value</code>。</p>
<p>此时 slog 不会报错，但输出日志结果 <code>&quot;!BADKEY&quot;: &quot;hello&quot;</code>，提示我们 <code>key/value</code> 数量不匹配。</p>
<p>为了避免这种错误发生，我们可以使用 <code>go vet</code> 工具来进行检查：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go vet .      </span><br><span class="line"><span class="comment"># github.com/jianghushinian/blog-go-example/log/slog</span></span><br><span class="line"><span class="comment"># [github.com/jianghushinian/blog-go-example/log/slog]</span></span><br><span class="line">./main.go:120:3: call to slog.Logger.Info missing a final value</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>go vet</code> 能够发现代码中 slog 输出的日志属性中 <code>key/value</code> 数量不匹配问题。</p>
<h4 id="使用强类型缓解可能出现不匹配的属性键值对"><a href="#使用强类型缓解可能出现不匹配的属性键值对" class="headerlink" title="使用强类型缓解可能出现不匹配的属性键值对"></a>使用强类型缓解可能出现不匹配的属性键值对</h4><p>我们可以使用 slog 提供的强类型 <code>key/value</code> 来缓解以上问题：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">l.Info(<span class="string">"info message"</span>, slog.String(<span class="string">"hello"</span>, <span class="string">"world"</span>), slog.Int(<span class="string">"status"</span>, <span class="number">200</span>))</span><br></pre></td></tr></table></figure>

<p>slog 提供了常见的基础类型方法，可以传入对应的 <code>key/value</code> 对。</p>
<p>使用 <code>slog.String</code>、<code>slog.Int</code> 等可以避免不匹配的 <code>key/value</code>。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:32:23.420762+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 135</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span>,</span><br><span class="line">    <span class="string">"status"</span>: 200</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是，使用强类型方法，依然不能限制我们传入普通的字符串类型 <code>key/value</code>。</p>
<p>我们还是可能写出如下代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">l.Info(<span class="string">"info message"</span>, slog.String(<span class="string">"hello"</span>, <span class="string">"world"</span>), slog.Int(<span class="string">"status"</span>, <span class="number">200</span>), <span class="string">"extra"</span>) <span class="comment">// "!BADKEY":"extra"</span></span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:32:23.420787+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 136</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span>,</span><br><span class="line">    <span class="string">"status"</span>: 200,</span><br><span class="line">    <span class="string">"!BADKEY"</span>: <span class="string">"extra"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="利用-LogAttrs-限制必须使用强类型，避免出现-BADKEY"><a href="#利用-LogAttrs-限制必须使用强类型，避免出现-BADKEY" class="headerlink" title="利用 LogAttrs 限制必须使用强类型，避免出现 !BADKEY"></a>利用 LogAttrs 限制必须使用强类型，避免出现 <code>!BADKEY</code></h4><p>这个时候，我们还有一种解决方案，就是使用 <code>LogAttrs</code> 来输出日志：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">l.LogAttrs(</span><br><span class="line">	context.Background(),</span><br><span class="line">	slog.LevelInfo,</span><br><span class="line">	<span class="string">"info message"</span>,</span><br><span class="line">	slog.String(<span class="string">"hello"</span>, <span class="string">"world"</span>),</span><br><span class="line">	slog.Int(<span class="string">"status"</span>, <span class="number">405</span>),</span><br><span class="line">	slog.Any(<span class="string">"err"</span>, errors.New(<span class="string">"http method not allowed"</span>)), <span class="comment">// error 类型可以使用 slog.Any 输出</span></span><br><span class="line">	<span class="comment">// "extra","text", // 编译不通过，类型不匹配</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>使用 <code>LogAttrs</code> 方法记录日志，用起来比 <code>Debug</code>、<code>Info</code> 等略显繁琐。不过，它限制只能传递 <code>slog.String</code>、<code>slog.Int</code> 这种强类型，如果传递普通字符串，则编译不通过。</p>
<p>如果要输出的 <code>value</code> 类型为 <code>error</code>，可以使用 <code>slog.Any</code> 输出。slog 支持的其他类型我就不一一列出来了，交给你自己去探索吧。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:33:27.820493+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 147</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span>,</span><br><span class="line">    <span class="string">"status"</span>: 405,</span><br><span class="line">    <span class="string">"err"</span>: <span class="string">"http method not allowed"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="属性分组"><a href="#属性分组" class="headerlink" title="属性分组"></a>属性分组</h4><p>我们可以使用 <code>slog.Group</code> 为一组 <code>key/value</code> 属性进行分组。</p>
<p>多说无益，我写个示例你就懂了。</p>
<h5 id="JSONHandler-1"><a href="#JSONHandler-1" class="headerlink" title="JSONHandler"></a>JSONHandler</h5><p>这是使用 <code>JSONHandler</code> 的属性分组示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">l.Info(</span><br><span class="line">	<span class="string">"info message"</span>,</span><br><span class="line">	slog.Group(<span class="string">"user"</span>, <span class="string">"name"</span>, <span class="string">"root"</span>, slog.Int(<span class="string">"age"</span>, <span class="number">20</span>)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:35:03.301692+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 167</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"user"</span>: &#123;</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"root"</span>,</span><br><span class="line">        <span class="string">"age"</span>: 20</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，<code>slog.Group</code> 第一个参数为分组名称 <code>user</code>，接下来传递的属性键值对都属于这个分组。</p>
<h5 id="TextHandler-1"><a href="#TextHandler-1" class="headerlink" title="TextHandler"></a>TextHandler</h5><p>使用 <code>TextHandler</code> 的属性分组示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewTextHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">l.Info(</span><br><span class="line">	<span class="string">"info message"</span>,</span><br><span class="line">	slog.Group(<span class="string">"user"</span>, <span class="string">"name"</span>, <span class="string">"root"</span>, slog.Int(<span class="string">"age"</span>, <span class="number">20</span>)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">time=2024-06-23T10:35:03.301+08:00 level=INFO <span class="built_in">source</span>=/workspace/projects/blog-go-example/<span class="built_in">log</span>/slog/main.go:180 msg=<span class="string">"info message"</span> user.name=root user.age=20</span><br></pre></td></tr></table></figure>

<p>有别于 <code>JSONHandler</code>，这里输出的属性结果是 <code>user.name</code> 形式，而非嵌套形式。</p>
<h4 id="使用子-logger"><a href="#使用子-logger" class="headerlink" title="使用子 logger"></a>使用子 logger</h4><p>可以使用 <code>With</code> 方法附加自定义属性到一个新的 <code>*slog.Logger</code> 对象。</p>
<p>这个新得到的 <code>*slog.Logger</code> 对象使用方式不变，但其所有日志记录都会携带统一的附加属性，非常适合简化代码。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"><span class="comment">// 附加自定义属性</span></span><br><span class="line">sl := l.With(<span class="string">"requestId"</span>, <span class="string">"10191529-bc34-4efe-95e4-ecac7321773a"</span>)</span><br><span class="line">sl.Debug(<span class="string">"debug message"</span>)</span><br><span class="line">sl.Info(<span class="string">"info message"</span>)</span><br></pre></td></tr></table></figure>

<p>我们为新的 <code>*slog.Logger</code> 对象 <code>sl</code> 附加了 <code>requestId</code>，这在 Web 开发中非常常用，可以用来追踪整个请求链。</p>
<p>接下来使用 <code>sl</code> 输出的日志都会携带这个 <code>requestId</code> 属性。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:35:53.966953+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"DEBUG"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 195</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"debug message"</span>,</span><br><span class="line">    <span class="string">"requestId"</span>: <span class="string">"10191529-bc34-4efe-95e4-ecac7321773a"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:35:53.966972+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 196</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"requestId"</span>: <span class="string">"10191529-bc34-4efe-95e4-ecac7321773a"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="为子-logger-属性分组"><a href="#为子-logger-属性分组" class="headerlink" title="为子 logger 属性分组"></a>为子 logger 属性分组</h4><p>子 <code>logger</code> 对象同样支持属性分组，示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">sl := l.WithGroup(<span class="string">"user"</span>).With(<span class="string">"requestId"</span>, <span class="string">"10191529-bc34-4efe-95e4-ecac7321773a"</span>)</span><br><span class="line">sl.Debug(<span class="string">"debug message"</span>, <span class="string">"name"</span>, <span class="string">"admin"</span>)</span><br><span class="line">sl.Info(<span class="string">"info message"</span>, <span class="string">"name"</span>, <span class="string">"admin"</span>)</span><br></pre></td></tr></table></figure>

<p>使用 <code>WithGroup</code> 方法可以对子 <code>logger</code> 属性进行分组，这里同时使用了 <code>With</code> 又得到一个新的子 <code>logger</code> 对象。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:37:01.62481+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"DEBUG"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 208</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"debug message"</span>,</span><br><span class="line">    <span class="string">"user"</span>: &#123;</span><br><span class="line">        <span class="string">"requestId"</span>: <span class="string">"10191529-bc34-4efe-95e4-ecac7321773a"</span></span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"admin"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:37:01.625249+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 209</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"user"</span>: &#123;</span><br><span class="line">        <span class="string">"requestId"</span>: <span class="string">"10191529-bc34-4efe-95e4-ecac7321773a"</span>,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"admin"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，使用 <code>With</code> 附加的属性和调用 <code>Debug</code>、<code>info</code> 方法附加的属性都被分组到了 <code>user</code> 中。</p>
<h4 id="实现-slog-LogValuer-接口，隐藏敏感信息"><a href="#实现-slog-LogValuer-接口，隐藏敏感信息" class="headerlink" title="实现 slog.LogValuer 接口，隐藏敏感信息"></a>实现 slog.LogValuer 接口，隐藏敏感信息</h4><p>有时候，我们可能要在日志中记录某个模型。</p>
<p>比如这里有一个 <code>User</code> 模型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID       <span class="keyword">int</span>    <span class="string">`json:"id"`</span></span><br><span class="line">	Name     <span class="keyword">string</span> <span class="string">`json:"name"`</span></span><br><span class="line">	Password <span class="keyword">string</span> <span class="string">`json:"password"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果直接将 <code>User</code> 实例对象传给 slog 进行记录，那么 <code>password</code> 属性也会被记录，这通常并不是我们想要的。</p>
<p>在使用 slog 以前，我的做法一般是为 <code>User</code> 模型定义一个 <code>SecureString</code> 方法，然后返回脱敏后的字符串，这样在记录日志时，可以将 <code>user.SecureString()</code> 结果传给日志记录器。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">SecureString</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	u.Password = <span class="string">""</span></span><br><span class="line">	res, _ := json.Marshal(u)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(res)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，slog 为我们提供了 <code>slog.LogValuer</code> 接口，一个对象只要实现这个接口，就可以直接传递给 slog 进行记录。</p>
<p><code>slog.LogValuer</code> 接口定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> LogValuer <span class="keyword">interface</span> &#123;</span><br><span class="line">	LogValue() Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，我们可以为 <code>User</code> 实现一个 <code>LogValue</code> 方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LogValue implements slog.LogValuer interface</span></span><br><span class="line"><span class="comment">// slog.Value 不可比较: https://jianghushinian.cn/2024/06/15/how-to-make-structures-incomparable-in-go/</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u *User)</span> <span class="title">LogValue</span><span class="params">()</span> <span class="title">slog</span>.<span class="title">Value</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> slog.GroupValue(</span><br><span class="line">		slog.Int(<span class="string">"id"</span>, u.ID),</span><br><span class="line">		slog.String(<span class="string">"name"</span>, u.Name),</span><br><span class="line">	)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LogValue</code> 方法返回 <code>slog.Value</code> 类型。</p>
<blockquote>
<p>NOTE:<br><code>slog.Value</code> 类型不可比较，可以参考我的另一篇文章：<a href="https://jianghushinian.cn/2024/06/15/how-to-make-structures-incomparable-in-go/" target="_blank" rel="noopener">《在 Go 中如何让结构体不可比较？》</a>。</p>
</blockquote>
<p>现在，我们直接将 <code>User</code> 实例传递给 slog 的日志记录方法看看效果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">l := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">	AddSource:   <span class="literal">true</span>,            <span class="comment">// 记录日志位置</span></span><br><span class="line">	Level:       slog.LevelDebug, <span class="comment">// 设置日志级别</span></span><br><span class="line">	ReplaceAttr: <span class="literal">nil</span>,</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">user := &amp;User&#123;</span><br><span class="line">	ID:       <span class="number">123</span>,</span><br><span class="line">	Name:     <span class="string">"jianghushinian"</span>,</span><br><span class="line">	Password: <span class="string">"pass"</span>,</span><br><span class="line">&#125;</span><br><span class="line">l.Info(<span class="string">"info message"</span>, <span class="string">"user1"</span>, user)  <span class="comment">// *User 未实现 slog.LogValuer 接口</span></span><br><span class="line">l.Info(<span class="string">"info message"</span>, <span class="string">"user2"</span>, *user) <span class="comment">// User 未实现 slog.LogValuer 接口，所以无法隐藏敏感信息</span></span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:38:03.64827+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 225</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"user1"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: 123,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"jianghushinian"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:38:03.648291+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 226</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"user2"</span>: &#123;</span><br><span class="line">        <span class="string">"id"</span>: 123,</span><br><span class="line">        <span class="string">"name"</span>: <span class="string">"jianghushinian"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"pass"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>值得注意的是，这里我为指针类型 <code>*User</code> 实现了 <code>slog.LogValuer</code> 接口，但值类型 <code>User</code> 并没有实现 <code>slog.LogValuer</code> 接口。所以记录日志时 <code>User</code> 实例指针可以隐藏 <code>password</code>，但 <code>User</code> 实例并不能。</p>
<h3 id="slog-是如何设计的"><a href="#slog-是如何设计的" class="headerlink" title="slog 是如何设计的"></a>slog 是如何设计的</h3><p>slog 是 Go 日志生态中的后起之秀，其设计之初可以参考的流行日志库有很多，比如 <code>logrus</code>、<code>zap</code>、<code>zerolog</code> 等。所以我们能在 slog 中看到其他日志库的影子，尤其是 <code>zap</code>。</p>
<blockquote>
<p>NOTE:<br>如果你想深入了解 <code>logrus</code> 可以参考我的文章：<a href="https://jianghushinian.cn/2023/03/15/use-of-logrus-in-go-third-party-log-library/" target="_blank" rel="noopener">《Go 第三方 log 库之 logrus 使用》</a>。<br>如果你想深入了解 <code>zap</code> 可以参考我的文章：<a href="https://jianghushinian.cn/2023/03/19/use-of-zap-in-go-third-party-log-library/" target="_blank" rel="noopener">《Go 第三方 log 库之 zap 使用》</a>、<a href="https://jianghushinian.cn/2023/04/16/how-to-wrap-a-more-user-friendly-logging-package-based-on-zap/" target="_blank" rel="noopener">《如何基于 zap 封装一个更好用的日志库》</a>。</p>
</blockquote>
<p>slog 核心组件有 3 个，分别是 <code>Logger</code>、<code>Record</code> 以及 <code>Handler</code>。</p>
<p><code>Logger</code> 是一个结构体，面向用户侧，其提供了 <code>Debug</code>、<code>Info</code> 等方法用于记录日志，定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">	handler Handler <span class="comment">// for structured logging</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Debug logs at [LevelDebug].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Debug</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.log(context.Background(), LevelDebug, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DebugContext logs at [LevelDebug] with the given context.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">DebugContext</span><span class="params">(ctx context.Context, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.log(ctx, LevelDebug, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Info logs at [LevelInfo].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Info</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.log(context.Background(), LevelInfo, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// InfoContext logs at [LevelInfo] with the given context.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">InfoContext</span><span class="params">(ctx context.Context, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.log(ctx, LevelInfo, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">log</span><span class="params">(ctx context.Context, level Level, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !l.Enabled(ctx, level) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> pc <span class="keyword">uintptr</span></span><br><span class="line">	<span class="keyword">if</span> !internal.IgnorePC &#123;</span><br><span class="line">		<span class="keyword">var</span> pcs [<span class="number">1</span>]<span class="keyword">uintptr</span></span><br><span class="line">		<span class="comment">// skip [runtime.Callers, this function, this function's caller]</span></span><br><span class="line">		runtime.Callers(<span class="number">3</span>, pcs[:])</span><br><span class="line">		pc = pcs[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	r := NewRecord(time.Now(), level, msg, pc)</span><br><span class="line">	r.Add(args...)</span><br><span class="line">	<span class="keyword">if</span> ctx == <span class="literal">nil</span> &#123;</span><br><span class="line">		ctx = context.Background()</span><br><span class="line">	&#125;</span><br><span class="line">	_ = l.Handler().Handle(ctx, r)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>可以发现，<code>Logger</code> 结构体定义非常简单，其内部唯一一个属性就是 <code>Handler</code>。</p>
<p><code>Record</code> 是一条日志条目，一个 <code>Record</code> 实例就代表了一条日志记录，定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Record holds information about a log event.</span></span><br><span class="line"><span class="keyword">type</span> Record <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// The time at which the output method (Log, Info, etc.) was called.</span></span><br><span class="line">	Time time.Time</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The log message.</span></span><br><span class="line">	Message <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The level of the event.</span></span><br><span class="line">	Level Level</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>Time</code> 是当前这条日志记录的时间，<code>Message</code> 是日志消息，<code>Level</code> 是日志级别。</p>
<p>而 <code>Handler</code> 是一个接口，用于处理 <code>Logger</code> 产生的日志条目 <code>Record</code>，定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Handler handles log records produced by a Logger.</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Enabled reports whether the handler handles records at the given level.</span></span><br><span class="line">	Enabled(context.Context, Level) <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Handle handles the Record.</span></span><br><span class="line">	Handle(context.Context, Record) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// WithAttrs returns a new Handler whose attributes consist of</span></span><br><span class="line">	<span class="comment">// both the receiver's attributes and the arguments.</span></span><br><span class="line">	WithAttrs(attrs []Attr) Handler</span><br><span class="line"></span><br><span class="line">	<span class="comment">// WithGroup returns a new Handler with the given group appended to</span></span><br><span class="line">	<span class="comment">// the receiver's existing groups.</span></span><br><span class="line">	WithGroup(name <span class="keyword">string</span>) Handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>slog 3 大核心组件导图如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="slog.png" alt="slog design" title="">
                </div>
                <div class="image-caption">slog design</div>
            </figure>

<p>这就是 slog 最核心的设计了。</p>
<p>从 slog 架构逻辑上讲，其中 <code>Logger</code> 被称为<code>前端</code>，<code>Handler</code> 被称为<code>后端</code>，而 <code>Record</code> 就是连接二者的桥梁。</p>
<p>记录一条日志流程如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="slog-record.png" alt="slog record" title="">
                </div>
                <div class="image-caption">slog record</div>
            </figure>

<p>用户调用前端 <code>Logger</code> 提供的日志记录方法 <code>Info</code> 记录一条日志，<code>Info</code> 方法会调用一个私有方法 <code>log</code>，<code>log</code> 方法内部会使用 <code>NewRecord</code> 创建一个日志条目 <code>Record</code>，最终，<code>Logger</code> 会调用其嵌入的 <code>Handler</code> 对象的 <code>Handle</code> 方法解析 <code>Record</code> 并执行日志记录逻辑。</p>
<p>现在是不是对 slog 的理解更加清晰了。</p>
<h3 id="定制-Logger"><a href="#定制-Logger" class="headerlink" title="定制 Logger"></a>定制 Logger</h3><p>了解了 slog 的日志设计，接下来我们就可以基于 <code>slog.Logger</code> 定制属于自己的 <code>Logger</code> 对象了。</p>
<p>我们要自定义的 <code>Logger</code> 对象需要支持 3 个功能：自定义日志级别、动态调整日志级别、以及正确输出日志位置。</p>
<h4 id="自定义日志级别"><a href="#自定义日志级别" class="headerlink" title="自定义日志级别"></a>自定义日志级别</h4><p>自定义的 <code>Logger</code> 对象首先要支持自定义日志级别：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Level = slog.Level</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LevelDebug = slog.LevelDebug</span><br><span class="line">	LevelTrace = slog.Level(<span class="number">-2</span>) <span class="comment">// 自定义日志级别</span></span><br><span class="line">	LevelInfo  = slog.LevelInfo</span><br><span class="line">	LevelWarn  = slog.LevelWarn</span><br><span class="line">	LevelError = slog.LevelError</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这里我们为 <code>slog.Level</code> 定义了一个别名 <code>Level</code>，并且在 <code>LevelDebug</code> 以及 <code>LevelInfo</code> 之间自定义了一个日志级别，其值为 <code>-2</code>。</p>
<p>因为 <code>LevelDebug</code> 值为 <code>-4</code>，<code>LevelInfo</code> 值为 <code>0</code>，所以我们最多可以在二者之间自定义 3 个日志级别 <code>-3</code>、<code>-2</code>、<code>-1</code>。</p>
<h4 id="动态设置日志级别"><a href="#动态设置日志级别" class="headerlink" title="动态设置日志级别"></a>动态设置日志级别</h4><p>自定义 <code>Logger</code> 结构体对象如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">	l   *slog.Logger</span><br><span class="line">	lvl *slog.LevelVar <span class="comment">// 用来动态调整日志级别</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Logger</code> 内部包含了 <code>*slog.Logger</code> 对象，以及 <code>*slog.LevelVar</code> 对象。</p>
<p>其中 <code>*slog.LevelVar</code> 类型支持通过 <code>*slog.LevelVar.Set(Level)</code> 动态调整日志级别。</p>
<p><code>Logger</code> 构造函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(level slog.Level)</span> *<span class="title">Logger</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lvl slog.LevelVar</span><br><span class="line">	lvl.Set(level)</span><br><span class="line"></span><br><span class="line">	h := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">		AddSource: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">		Level: &amp;lvl, <span class="comment">// 支持动态设置日志级别</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 修改日志中的 Attr 键值对（即日志记录中附加的 key/value）</span></span><br><span class="line">		ReplaceAttr: <span class="function"><span class="keyword">func</span><span class="params">(groups []<span class="keyword">string</span>, a slog.Attr)</span> <span class="title">slog</span>.<span class="title">Attr</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> a.Key == slog.LevelKey &#123;</span><br><span class="line">				level := a.Value.Any().(slog.Level)</span><br><span class="line">				levelLabel := level.String()</span><br><span class="line"></span><br><span class="line">				<span class="keyword">switch</span> level &#123;</span><br><span class="line">				<span class="keyword">case</span> LevelTrace:</span><br><span class="line">					<span class="comment">// <span class="doctag">NOTE:</span> 如果不设置，默认日志级别打印为 "level":"DEBUG+2"</span></span><br><span class="line">					levelLabel = <span class="string">"TRACE"</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				a.Value = slog.StringValue(levelLabel)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> a</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Logger&#123;l: h, lvl: &amp;lvl&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义 <code>Logger</code> 使用 <code>JSONHandler</code> 作为默认的 <code>Handler</code>，这里终于用上了 <code>ReplaceAttr</code> 属性。</p>
<p><code>*slog.HandlerOptions</code> 的 <code>ReplaceAttr</code> 属性接收一个函数，第一个参数是日志分组 <code>groups</code>，即我们通过 <code>slog.Group</code> 指定的组，第二个参数是 <code>slog.Attr</code> 类型，它其实就是日志条目中包含的所有附加属性 <code>key/value</code>。</p>
<p>所以，其实每记录一条日志，都会多次调用这个方法，并将日志条目对应的分组和属性传递进来，方便我们进行修改，并返回最终修改后的属性。</p>
<p>这也就给了我们一个机会，可以判断当前日志条目的级别，而自定义日志级别输出结果如何，完全掌握在我们自己手中。</p>
<p>根据前文的示例讲解，你应该也能发现，日志条目中的时间和级别等属性，都是 slog 自动加上去的。而属性的 <code>key</code> 其实被定义为了常量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Keys for "built-in" attributes.</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	<span class="comment">// TimeKey is the key used by the built-in handlers for the time</span></span><br><span class="line">	<span class="comment">// when the log method is called. The associated Value is a [time.Time].</span></span><br><span class="line">	TimeKey = <span class="string">"time"</span></span><br><span class="line">	<span class="comment">// LevelKey is the key used by the built-in handlers for the level</span></span><br><span class="line">	<span class="comment">// of the log call. The associated value is a [Level].</span></span><br><span class="line">	LevelKey = <span class="string">"level"</span></span><br><span class="line">	<span class="comment">// MessageKey is the key used by the built-in handlers for the</span></span><br><span class="line">	<span class="comment">// message of the log call. The associated value is a string.</span></span><br><span class="line">	MessageKey = <span class="string">"msg"</span></span><br><span class="line">	<span class="comment">// SourceKey is the key used by the built-in handlers for the source file</span></span><br><span class="line">	<span class="comment">// and line of the log call. The associated value is a *[Source].</span></span><br><span class="line">	SourceKey = <span class="string">"source"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>slog 内置了这 4 个常量作为属性的 <code>key</code>，所以在 <code>ReplaceAttr</code> 方法中，我们可以通过 <code>if a.Key == slog.LevelKey</code> 判断这个属性是否为日志级别。</p>
<p>如果是日志级别，并且日志级别为自定义的 <code>LevelTrace</code>，则设置其字符串形式为 <code>TRACE</code>。</p>
<p>而动态调整日志级别其实是 slog 自带的功能，我们只需要代理一下 <code>*slog.LevelVar.Set</code> 方法即可：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SetLevel 动态调整日志级别</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">SetLevel</span><span class="params">(level Level)</span></span> &#123;</span><br><span class="line">	l.lvl.Set(level)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="设置-caller-skip"><a href="#设置-caller-skip" class="headerlink" title="设置 caller skip"></a>设置 caller skip</h4><p>自定义 <code>Logger</code> 还要解决一个重要问题。</p>
<p>不知道你有没有注意，前文在介绍 <a href="#slog-是如何设计的">slog是如何设计的</a> 时候，给出的 <code>slog.Logger</code> 源码定义中，不管是 <code>Debug</code> 还是 <code>Info</code> 方法，其实它们内部都调用了 <code>slog.Logger.log</code> 方法。所以 <code>slog.Logger.log</code> 方法是 <code>slog.Logger</code> 的核心方法。</p>
<p>再次回顾下 <code>slog.Logger.log</code> 方法的定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// log is the low-level logging method for methods that take ...any.</span></span><br><span class="line"><span class="comment">// It must always be called directly by an exported logging method</span></span><br><span class="line"><span class="comment">// or function, because it uses a fixed call depth to obtain the pc.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">log</span><span class="params">(ctx context.Context, level Level, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !l.Enabled(ctx, level) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> pc <span class="keyword">uintptr</span></span><br><span class="line">	<span class="keyword">if</span> !internal.IgnorePC &#123;</span><br><span class="line">		<span class="keyword">var</span> pcs [<span class="number">1</span>]<span class="keyword">uintptr</span></span><br><span class="line">		<span class="comment">// skip [runtime.Callers, this function, this function's caller]</span></span><br><span class="line">		runtime.Callers(<span class="number">3</span>, pcs[:])</span><br><span class="line">		pc = pcs[<span class="number">0</span>]</span><br><span class="line">	&#125;</span><br><span class="line">	r := NewRecord(time.Now(), level, msg, pc)</span><br><span class="line">	r.Add(args...)</span><br><span class="line">	<span class="keyword">if</span> ctx == <span class="literal">nil</span> &#123;</span><br><span class="line">		ctx = context.Background()</span><br><span class="line">	&#125;</span><br><span class="line">	_ = l.Handler().Handle(ctx, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法中，先通过 <code>if !l.Enabled(ctx, level)</code> 判断当前日志级别是否启用，如果没启用则丢弃这条日志，否则继续执行。</p>
<p>这里有一行重点代码 <code>runtime.Callers(3, pcs[:])</code>，这行是专门用来准确记录日志位置的，在构造 <code>Handler</code> 时如果传入的 <code>*slog.HandlerOptions</code> 对象开启了 <code>AddSource</code> 选项，就会使用这里的逻辑记录日志的正确位置。</p>
<p><code>runtime.Callers</code> 能够获取调用堆栈的程序计数器，3 表示跳过前 3 个调用者，包括 <code>runtime.Callers</code> 自身、当前的 <code>log</code> 函数和它的直接调用者 <code>Debug</code>、<code>Info</code> 等。</p>
<p>遗憾的是，这里 3 是写死的魔法数字，不是通过参数传递进来的。因为我们还会对 slog 的日志记录函数进行包装，所以，我们自定义的 <code>Logger</code> 对象在记录日志时无法获得准确的日志位置。</p>
<p>比如定义 <code>Debug</code> 方法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Debug</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 不会走 *customlog.Logger.log() 调用，会走 *slog.Logger.log() 调用</span></span><br><span class="line">	l.l.Debug(msg, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里直接代理到 <code>*slog.Logger.Debug</code> 方法。</p>
<p>现在如果你使用 <code>New</code> 函数创建一个自定义 <code>Logger</code> 对象，然后调用 <code>*Logger.Debug</code> 方法记录日志，将得到错误的日志位置。</p>
<p>为了解决这个问题，正确的做法是，我们可以重写 <code>slog.Logger.log</code> 方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">log</span><span class="params">(ctx context.Context, level slog.Level, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !l.l.Enabled(ctx, level) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> pc <span class="keyword">uintptr</span></span><br><span class="line">	<span class="keyword">var</span> pcs [<span class="number">1</span>]<span class="keyword">uintptr</span></span><br><span class="line">	<span class="comment">// skip [runtime.Callers, this function, this function's caller]</span></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 这里修改 skip 为 4，*slog.Logger.log 源码中 skip 为 3</span></span><br><span class="line">	runtime.Callers(<span class="number">4</span>, pcs[:])</span><br><span class="line">	pc = pcs[<span class="number">0</span>]</span><br><span class="line">	r := slog.NewRecord(time.Now(), level, msg, pc)</span><br><span class="line">	r.Add(args...)</span><br><span class="line">	<span class="keyword">if</span> ctx == <span class="literal">nil</span> &#123;</span><br><span class="line">		ctx = context.Background()</span><br><span class="line">	&#125;</span><br><span class="line">	_ = l.l.Handler().Handle(ctx, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里几乎是 <code>slog.Logger.log</code> 方法的拷贝，只不过将 <code>runtime.Callers(3, pcs[:])</code> 中的 <code>3</code> 换成了 <code>4</code>。</p>
<p>因为我们自定义的日志记录方法包装了 <code>slog.Logger</code> 对应的日志记录方法，这就多了一层调用，所以 <code>runtime.Callers</code> 的 <code>skip</code> 参数值就需要加 <code>1</code>。</p>
<blockquote>
<p>NOTE:<br>你可能纠结于 <code>if !internal.IgnorePC {</code> 这个判断条件被我们忽略了，没关系，这个判断实际上是为了在性能测试时关闭记录日志位置的功能，以此提升性能。所以，关闭忽略它并不影响我们的程序功能。</p>
</blockquote>
<p>然后定义几个常用的日志记录方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Info</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="comment">// l.l.Info(msg, args...)</span></span><br><span class="line">	l.Log(context.Background(), LevelInfo, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trace 自定义的日志级别</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Trace</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.Log(context.Background(), LevelTrace, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Warn</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="comment">// l.l.Warn(msg, args...)</span></span><br><span class="line">	l.Log(context.Background(), LevelWarn, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Error</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="comment">// l.l.Error(msg, args...)</span></span><br><span class="line">	l.Log(context.Background(), LevelError, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Log</span><span class="params">(ctx context.Context, level slog.Level, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.log(ctx, level, msg, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在自定义 <code>Logger</code> 对象暴露的顶层方日志记录方法，都会调用我们自定义的 <code>*Logger.log</code> 方法，而非 <code>*slog.Logger.log</code> 方法。也就解决了日志记录位置不准确的问题。</p>
<h4 id="完整-Logger-代码实现"><a href="#完整-Logger-代码实现" class="headerlink" title="完整 Logger 代码实现"></a>完整 Logger 代码实现</h4><p>至此，我们得到了自定义日志包的完整代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> customlog</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"log/slog"</span></span><br><span class="line">	<span class="string">"os"</span></span><br><span class="line">	<span class="string">"runtime"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Level = slog.Level</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	LevelDebug = slog.LevelDebug</span><br><span class="line">	LevelTrace = slog.Level(<span class="number">-2</span>) <span class="comment">// 自定义日志级别</span></span><br><span class="line">	LevelInfo  = slog.LevelInfo</span><br><span class="line">	LevelWarn  = slog.LevelWarn</span><br><span class="line">	LevelError = slog.LevelError</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</span><br><span class="line">	l   *slog.Logger</span><br><span class="line">	lvl *slog.LevelVar <span class="comment">// 用来动态调整日志级别</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(level slog.Level)</span> *<span class="title">Logger</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lvl slog.LevelVar</span><br><span class="line">	lvl.Set(level)</span><br><span class="line"></span><br><span class="line">	h := slog.New(slog.NewJSONHandler(os.Stdout, &amp;slog.HandlerOptions&#123;</span><br><span class="line">		AddSource: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Level:     level, // 静态设置日志级别</span></span><br><span class="line">		Level: &amp;lvl, <span class="comment">// 支持动态设置日志级别</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 修改日志中的 Attr 键值对（即日志记录中附加的 key/value）</span></span><br><span class="line">		ReplaceAttr: <span class="function"><span class="keyword">func</span><span class="params">(groups []<span class="keyword">string</span>, a slog.Attr)</span> <span class="title">slog</span>.<span class="title">Attr</span></span> &#123;</span><br><span class="line">			<span class="keyword">if</span> a.Key == slog.LevelKey &#123;</span><br><span class="line">				level := a.Value.Any().(slog.Level)</span><br><span class="line">				levelLabel := level.String()</span><br><span class="line"></span><br><span class="line">				<span class="keyword">switch</span> level &#123;</span><br><span class="line">				<span class="keyword">case</span> LevelTrace:</span><br><span class="line">					<span class="comment">// <span class="doctag">NOTE:</span> 如果不设置，默认日志级别打印为 "level":"DEBUG+2"</span></span><br><span class="line">					levelLabel = <span class="string">"TRACE"</span></span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				a.Value = slog.StringValue(levelLabel)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// <span class="doctag">NOTE:</span> 可以在这里修改时间输出格式</span></span><br><span class="line">			<span class="comment">// if a.Key == slog.TimeKey &#123;</span></span><br><span class="line">			<span class="comment">// 	if t, ok := a.Value.Any().(time.Time); ok &#123;</span></span><br><span class="line">			<span class="comment">// 		a.Value = slog.StringValue(t.Format(time.DateTime))</span></span><br><span class="line">			<span class="comment">// 	&#125;</span></span><br><span class="line">			<span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> a</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;))</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;Logger&#123;l: h, lvl: &amp;lvl&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SetLevel 动态调整日志级别</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">SetLevel</span><span class="params">(level Level)</span></span> &#123;</span><br><span class="line">	l.lvl.Set(level)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Debug</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 不会走 *customlog.Logger.log() 调用，会走 *slog.Logger.log() 调用</span></span><br><span class="line">	l.l.Debug(msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Info</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.Log(context.Background(), LevelInfo, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trace 自定义的日志级别</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Trace</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.Log(context.Background(), LevelTrace, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Warn</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.Log(context.Background(), LevelWarn, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Error</span><span class="params">(msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.Log(context.Background(), LevelError, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Log</span><span class="params">(ctx context.Context, level slog.Level, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	l.log(ctx, level, msg, args...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// log is the low-level logging method for methods that take ...any.</span></span><br><span class="line"><span class="comment">// It must always be called directly by an exported logging method</span></span><br><span class="line"><span class="comment">// or function, because it uses a fixed call depth to obtain the pc.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">log</span><span class="params">(ctx context.Context, level slog.Level, msg <span class="keyword">string</span>, args ...any)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !l.l.Enabled(ctx, level) &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> pc <span class="keyword">uintptr</span></span><br><span class="line">	<span class="keyword">var</span> pcs [<span class="number">1</span>]<span class="keyword">uintptr</span></span><br><span class="line">	<span class="comment">// skip [runtime.Callers, this function, this function's caller]</span></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 这里修改 skip 为 4，*slog.Logger.log 源码中 skip 为 3</span></span><br><span class="line">	runtime.Callers(<span class="number">4</span>, pcs[:])</span><br><span class="line">	pc = pcs[<span class="number">0</span>]</span><br><span class="line">	r := slog.NewRecord(time.Now(), level, msg, pc)</span><br><span class="line">	r.Add(args...)</span><br><span class="line">	<span class="keyword">if</span> ctx == <span class="literal">nil</span> &#123;</span><br><span class="line">		ctx = context.Background()</span><br><span class="line">	&#125;</span><br><span class="line">	_ = l.l.Handler().Handle(ctx, r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"github.com/jianghushinian/blog-go-example/log/slog/customlog"</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">l := customlog.New(customlog.LevelDebug)</span><br><span class="line">l.Debug(<span class="string">"custom debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">l.Trace(<span class="string">"custom trace message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">l.Info(<span class="string">"custom info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line"></span><br><span class="line">l.SetLevel(customlog.LevelInfo)</span><br><span class="line">l.Debug(<span class="string">"custom debug message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">l.Trace(<span class="string">"custom trace message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br><span class="line">l.Info(<span class="string">"custom info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:39:28.563559+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"DEBUG"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"github.com/jianghushinian/blog-go-example/log/slog/customlog.(*Logger).Debug"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/customlog/customlog.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 72</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"custom debug message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:39:28.563785+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"TRACE"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 233</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"custom trace message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span></span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:39:28.563815+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 234</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"custom info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 动态调整日志级别以后输出</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:39:28.56384+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"source"</span>: &#123;</span><br><span class="line">        <span class="string">"function"</span>: <span class="string">"main.main"</span>,</span><br><span class="line">        <span class="string">"file"</span>: <span class="string">"/workspace/projects/blog-go-example/log/slog/main.go"</span>,</span><br><span class="line">        <span class="string">"line"</span>: 239</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"custom info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了对比效果，<code>Debug</code> 方法并没有改为调用自定义 <code>log</code> 方法，依旧是被代理到 <code>*slog.Logger.Debug</code> 方法。</p>
<p>可以发现，<code>Debug</code> 记录的日志输出位置是错误的，并不是 <code>l.Debug(&quot;custom debug message&quot;, &quot;hello&quot;, &quot;world&quot;)</code> 这行代码的位置，而是 <code>Debug</code> 定义的位置。</p>
<p><code>Trace</code> 和 <code>Info</code> 日志级别都能被正确记录。</p>
<p>特别强调 <code>Trace</code> 日志中输出了 <code>&quot;level&quot;: &quot;TRACE&quot;</code> 属性键值对。如果我们没有在 <code>ReplaceAttr</code> 方法中修改 <code>levelLabel</code> 的字符串形式，我们将会得到 <code>&quot;level&quot;:&quot;DEBUG+2&quot;</code>，即这个日志级别 slog 不认识，但它知道其值比 <code>LevelDebug</code> 大 <code>2</code>。因为 <code>LevelDebug</code> 值为 <code>-4</code>，<code>LevelTrace</code> 值为 <code>-2</code>（为了加深理解，你可以注释掉相关代码，再执行下示例程序，看看效果）。</p>
<p>当我们使用 <code>l.SetLevel(customlog.LevelInfo)</code> 动态调整日志级别以后，仅 <code>Info</code> 级别的日志会被输出。</p>
<p>看来我们自定义的 <code>Logger</code> 实现完成了它的 3 个使命。</p>
<h3 id="自定义-Handler"><a href="#自定义-Handler" class="headerlink" title="自定义 Handler"></a>自定义 Handler</h3><p>既然讲解了如何自定义 slog 的前端 <code>Logger</code>，我们不妨看一下如何自定义 slog 的后端 <code>Handler</code>。</p>
<p>根据前文的讲解，我们知道 <code>Handler</code> 是一个接口，回顾下其定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A Handler handles log records produced by a Logger.</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Enabled reports whether the handler handles records at the given level.</span></span><br><span class="line">	Enabled(context.Context, Level) <span class="keyword">bool</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Handle handles the Record.</span></span><br><span class="line">	Handle(context.Context, Record) error</span><br><span class="line"></span><br><span class="line">	<span class="comment">// WithAttrs returns a new Handler whose attributes consist of</span></span><br><span class="line">	<span class="comment">// both the receiver's attributes and the arguments.</span></span><br><span class="line">	WithAttrs(attrs []Attr) Handler</span><br><span class="line"></span><br><span class="line">	<span class="comment">// WithGroup returns a new Handler with the given group appended to</span></span><br><span class="line">	<span class="comment">// the receiver's existing groups.</span></span><br><span class="line">	WithGroup(name <span class="keyword">string</span>) Handler</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然是接口，那么我们自定义的 <code>Handler</code> 其实只要实现这个接口就行了。</p>
<p>自定义 <code>Handler</code> 代码实现如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> customlog</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"context"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"log/slog"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handler 自定义日志后端 slog.Handler</span></span><br><span class="line"><span class="keyword">type</span> Handler <span class="keyword">struct</span> &#123;</span><br><span class="line">	slog.Handler</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewHandler 创建新的日志后端 handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewHandler</span><span class="params">(w io.Writer, opts *slog.HandlerOptions)</span> *<span class="title">Handler</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Handler&#123;</span><br><span class="line">		Handler: slog.NewJSONHandler(w, opts),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enabled 当前日志级别是否开启</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">Enabled</span><span class="params">(ctx context.Context, level slog.Level)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> h.Handler.Enabled(ctx, level)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle 处理日志记录，仅在 Enabled() 返回 true 时才会被调用</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">Handle</span><span class="params">(ctx context.Context, record slog.Record)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	record.Add(<span class="string">"customlog"</span>, <span class="string">"handler"</span>)</span><br><span class="line">	<span class="keyword">return</span> h.Handler.Handle(ctx, record)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WithAttrs 从现有的 handler 创建一个新的 handler，并将新增属性附加到新的 handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">WithAttrs</span><span class="params">(attrs []slog.Attr)</span> <span class="title">slog</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> h.Handler.WithAttrs(attrs)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WithGroup 从现有的 handler 创建一个新的 handler，并将指定分组附加到新的 handler</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *Handler)</span> <span class="title">WithGroup</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">slog</span>.<span class="title">Handler</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> h.Handler.WithGroup(name)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里，为了示例足够简单，我并没有做太多的工作，自定义的 <code>Handler</code> 仅代理了 <code>*slog.JSONHandler</code>。并在 <code>Handle</code> 方法中对日志条目 <code>Record</code> 附加了一对属性 <code>record.Add(&quot;customlog&quot;, &quot;handler&quot;)</code>。</p>
<p>现在，这个自定义 <code>Handler</code> 就可以使用了：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"github.com/jianghushinian/blog-go-example/log/slog/customlog"</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">l := slog.New(customlog.NewHandler(os.Stdout, <span class="literal">nil</span>))</span><br><span class="line">l.Info(<span class="string">"info message"</span>, <span class="string">"hello"</span>, <span class="string">"world"</span>)</span><br></pre></td></tr></table></figure>

<p>我们直接将构造的自定义 <code>Handler</code> 传递给 <code>slog.New</code>，得到一个新的 <code>*slog.Logger</code> 对象，然后用其记录一条日志。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"time"</span>: <span class="string">"2024-06-23T10:40:31.509387+08:00"</span>,</span><br><span class="line">    <span class="string">"level"</span>: <span class="string">"INFO"</span>,</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"info message"</span>,</span><br><span class="line">    <span class="string">"hello"</span>: <span class="string">"world"</span>,</span><br><span class="line">    <span class="string">"customlog"</span>: <span class="string">"handler"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没错，就是这么简单，我们实现了自定义 slog 的后端 <code>Handler</code>。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>本文对 slog 的常用 API 进行了演示讲解。比如附加属性、结构化日志、属性分组等。</p>
<p>接下来我为你介绍了 slog 是如何设计的，slog 包含 3 大核心对象：<code>Logger</code>、<code>Record</code>、<code>Handler</code>。<code>Logger</code> 又被称为 <code>前端</code>，<code>Handler</code> 被称为 <code>后端</code>，而 <code>Record</code> 用来表示一条日志。</p>
<p>前端 <code>Logger</code> 直接面向用户侧，我们可以对其进行二次封装，来定制自己的用户 API。</p>
<p>后端 <code>Handler</code> 可以统一日志处理接口，我们也可以在自定义的 <code>Handler</code> 中很方便的集成如 <code>zap</code>、<code>zerolog</code> 等第三方日志库。你可以在 <a href="https://tip.golang.org/wiki/Resources-for-slog" target="_blank" rel="noopener">Go Wiki: Resources for slog
</a> 这个列表找到一些灵感。</p>
<p>slog 更多用法就等着你自己去探索了，祝你好运。</p>
<p>如果你比较在意日志库性能，这个项目 <a href="https://github.com/betterstack-community/go-logging-benchmarks" target="_blank" rel="noopener">go-logging-benchmarks</a> 有 Go 流行日志库的性能对比，供你参考。</p>
<p>本文示例源码我都放在了 <a href="https://github.com/jianghushinian/blog-go-example/tree/main/log/slog" target="_blank" rel="noopener">GitHub</a> 中，欢迎点击查看。</p>
<p>希望此文能对你有所启发。</p>
<p><strong>延伸阅读</strong></p>
<ul>
<li>slog 源码: <a href="https://github.com/golang/go/tree/go1.22.0/src/log/slog" target="_blank" rel="noopener">https://github.com/golang/go/tree/go1.22.0/src/log/slog</a></li>
<li>slog Documentation: <a href="https://pkg.go.dev/log/slog@go1.22.0" target="_blank" rel="noopener">https://pkg.go.dev/log/slog@go1.22.0</a></li>
<li>Structured Logging with slog: <a href="https://go.dev/blog/slog" target="_blank" rel="noopener">https://go.dev/blog/slog</a></li>
<li>A Guide to Writing slog Handlers: <a href="https://github.com/golang/example/blob/master/slog-handler-guide/guide.md" target="_blank" rel="noopener">https://github.com/golang/example/blob/master/slog-handler-guide/guide.md</a></li>
<li>Logging in Go with Slog: The Ultimate Guide: <a href="https://betterstack.com/community/guides/logging/logging-in-go/" target="_blank" rel="noopener">https://betterstack.com/community/guides/logging/logging-in-go/</a></li>
<li>How to Retrieve Log Level with “slog” Package in Go?: <a href="https://stackoverflow.com/questions/77504588/how-to-retrieve-log-level-with-slog-package-in-go" target="_blank" rel="noopener">https://stackoverflow.com/questions/77504588/how-to-retrieve-log-level-with-slog-package-in-go</a></li>
<li>go-logging-benchmarks: <a href="https://github.com/betterstack-community/go-logging-benchmarks" target="_blank" rel="noopener">https://github.com/betterstack-community/go-logging-benchmarks</a></li>
<li>slog正式版来了：Go日志记录新选择！: <a href="https://tonybai.com/2023/09/01/slog-a-new-choice-for-logging-in-go/" target="_blank" rel="noopener">https://tonybai.com/2023/09/01/slog-a-new-choice-for-logging-in-go/</a></li>
<li>深入探究 Go log 标准库: <a href="https://jianghushinian.cn/2023/03/11/dive-into-the-go-log-standard-library/" target="_blank" rel="noopener">https://jianghushinian.cn/2023/03/11/dive-into-the-go-log-standard-library/</a></li>
<li>Go 第三方 log 库之 logrus 使用: <a href="https://jianghushinian.cn/2023/03/15/use-of-logrus-in-go-third-party-log-library/" target="_blank" rel="noopener">https://jianghushinian.cn/2023/03/15/use-of-logrus-in-go-third-party-log-library/</a></li>
<li>Go 第三方 log 库之 zap 使用: <a href="https://jianghushinian.cn/2023/03/19/use-of-zap-in-go-third-party-log-library/" target="_blank" rel="noopener">https://jianghushinian.cn/2023/03/19/use-of-zap-in-go-third-party-log-library/</a></li>
<li>如何基于 zap 封装一个更好用的日志库: <a href="https://jianghushinian.cn/2023/04/16/how-to-wrap-a-more-user-friendly-logging-package-based-on-zap/" target="_blank" rel="noopener">https://jianghushinian.cn/2023/04/16/how-to-wrap-a-more-user-friendly-logging-package-based-on-zap/</a></li>
<li>本文 GitHub 示例代码：<a href="https://github.com/jianghushinian/blog-go-example/tree/main/log/slog" target="_blank" rel="noopener">https://github.com/jianghushinian/blog-go-example/tree/main/log/slog</a></li>
</ul>
<p><strong>联系我</strong></p>
<ul>
<li>公众号：<a href="https://jianghushinian.cn/about" target="_blank" rel="noopener">Go编程世界</a></li>
<li>微信：jianghushinian</li>
<li>邮箱：<a href="mailto:jianghushinian007@outlook.com">jianghushinian007@outlook.com</a></li>
<li>博客：<a href="https://jianghushinian.cn" target="_blank" rel="noopener">https://jianghushinian.cn</a></li>
</ul>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2024-06-24T01:44:27.853Z" itemprop="dateUpdated">2024-06-24 09:44:27</time>
</span><br>


        
        <a href="/2024/06/24/go-s-official-structured-log-package-slog/" target="_blank" rel="external">http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/</a>
        
    </div>
    
    <footer>
        <a href="http://www.jianghushinian.cn">
            <img src="/img/avatar.png" alt="江湖十年">
            江湖十年
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/" rel="tag">Go</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Log/" rel="tag">Log</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/&title=《万字解析 Go 官方结构体化日志包 slog》 — 江湖十年&pic=http://www.jianghushinian.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/&title=《万字解析 Go 官方结构体化日志包 slog》 — 江湖十年&source=slog 日志包是 Go 语言中的一个结构化日志库，旨在提供一个简单而强大的日志系统。因为标准日志库 log 过于简陋，社区中经常有人吐槽，Go 官方也承..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《万字解析 Go 官方结构体化日志包 slog》 — 江湖十年&url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/&via=http://www.jianghushinian.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2024/06/19/i-have-helped-you-practice-the-fat-reducing-methods-that-are-feasible-for-ordinary-people/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">软技能，代码之外的生存指南：普通人可行的减脂方法，我帮你实践过了！</h4>
      </a>
    </div>
  
</nav>



    


    <script src="/js/md5.min.js"></script>
    <section class="comments" id="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'https-jianghushinian-cn';
            var disqus_identifier = location.pathname.slice(1,);
            var disqus_url = 'https://jianghushinian.cn/' + disqus_identifier;
            (function () {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the comments.</noscript>
    </section>


















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        <span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>江湖十年 &copy; 2019 - 2024</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/&title=《万字解析 Go 官方结构体化日志包 slog》 — 江湖十年&pic=http://www.jianghushinian.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/&title=《万字解析 Go 官方结构体化日志包 slog》 — 江湖十年&source=slog 日志包是 Go 语言中的一个结构化日志库，旨在提供一个简单而强大的日志系统。因为标准日志库 log 过于简陋，社区中经常有人吐槽，Go 官方也承..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《万字解析 Go 官方结构体化日志包 slog》 — 江湖十年&url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/&via=http://www.jianghushinian.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://www.jianghushinian.cn/2024/06/24/go-s-official-structured-log-package-slog/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
