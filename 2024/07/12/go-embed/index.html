<!DOCTYPE html>
<html>
<head>
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>在 Go 中如何使用 go:embed 指令嵌入静态文件 | 江湖十年 | 学而不思则罔，思而不学则殆。</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Go">
    <meta name="description" content="有时候，将配置文件、模板甚至整个前端应用直接嵌入到 Go 二进制文件中，是一种提高应用部署效率和简化操作的有效方法。自从 Go 1.16 版本起，Go 语言官方引入了 &#x2F;&#x2F;go:embed 指令，这使得嵌入静态资源变得异常简单而直接。本文将详细介绍如何在你的 Go 应用中使用这一强大的特性。">
<meta property="og:type" content="article">
<meta property="og:title" content="在 Go 中如何使用 go:embed 指令嵌入静态文件">
<meta property="og:url" content="http://www.jianghushinian.cn/2024/07/12/go-embed/index.html">
<meta property="og:site_name" content="江湖十年">
<meta property="og:description" content="有时候，将配置文件、模板甚至整个前端应用直接嵌入到 Go 二进制文件中，是一种提高应用部署效率和简化操作的有效方法。自从 Go 1.16 版本起，Go 语言官方引入了 &#x2F;&#x2F;go:embed 指令，这使得嵌入静态资源变得异常简单而直接。本文将详细介绍如何在你的 Go 应用中使用这一强大的特性。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.jianghushinian.cn/2024/07/12/go-embed/static.png">
<meta property="og:image" content="http://www.jianghushinian.cn/2024/07/12/go-embed/embed-static.png">
<meta property="og:image" content="http://www.jianghushinian.cn/2024/07/12/go-embed/email.png">
<meta property="article:published_time" content="2024-07-12T06:23:45.000Z">
<meta property="article:modified_time" content="2024-07-14T16:13:52.915Z">
<meta property="article:author" content="江湖十年">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.jianghushinian.cn/2024/07/12/go-embed/static.png">
    
        <link rel="alternate" type="application/atom+xml" title="江湖十年" href="/atom.xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.png">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">江湖十年</h5>
          <a href="mailto:jianghushinian007@outlook.com" title="jianghushinian007@outlook.com" class="mail">jianghushinian007@outlook.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-link"></i>
                关于
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/jianghushinian" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">在 Go 中如何使用 go:embed 指令嵌入静态文件</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">在 Go 中如何使用 go:embed 指令嵌入静态文件</h1>
        <h5 class="subtitle">
            
                <time datetime="2024-07-12T06:23:45.000Z" itemprop="datePublished" class="page-time">
  2024-07-12
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Go/">Go</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#什么是-go-embed"><span class="post-toc-number">1.</span> <span class="post-toc-text">什么是 go:embed</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#快速开始"><span class="post-toc-number">2.</span> <span class="post-toc-text">快速开始</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#在-HTTP-Server-中使用-go-embed"><span class="post-toc-number">3.</span> <span class="post-toc-text">在 HTTP Server 中使用 go:embed</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#在单元测试中使用-go-embed"><span class="post-toc-number">4.</span> <span class="post-toc-text">在单元测试中使用 go:embed</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用-go-embed-嵌入父目录"><span class="post-toc-number">5.</span> <span class="post-toc-text">使用 go:embed 嵌入父目录</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#使用-go-embed-的注意事项"><span class="post-toc-number">6.</span> <span class="post-toc-text">使用 go:embed 的注意事项</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#安全性"><span class="post-toc-number">6.1.</span> <span class="post-toc-text">安全性</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#patterns-规则"><span class="post-toc-number">6.2.</span> <span class="post-toc-text">patterns 规则</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#path-Match"><span class="post-toc-number">6.3.</span> <span class="post-toc-text">path.Match</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#全局变量"><span class="post-toc-number">6.4.</span> <span class="post-toc-text">全局变量</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#总结"><span class="post-toc-number">7.</span> <span class="post-toc-text">总结</span></a></li></ol>
        </nav>
    </aside>


<article id="post-go-embed"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">在 Go 中如何使用 go:embed 指令嵌入静态文件</h1>
        <div class="post-meta">
            <time class="post-time" title="2024-07-12 14:23:45" datetime="2024-07-12T06:23:45.000Z"  itemprop="datePublished">2024-07-12</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Go/">Go</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>有时候，将配置文件、模板甚至整个前端应用直接嵌入到 Go 二进制文件中，是一种提高应用部署效率和简化操作的有效方法。自从 Go 1.16 版本起，Go 语言官方引入了 <code>//go:embed</code> 指令，这使得嵌入静态资源变得异常简单而直接。本文将详细介绍如何在你的 Go 应用中使用这一强大的特性。</p>
<a id="more"></a>

<h3 id="什么是-go-embed"><a href="#什么是-go-embed" class="headerlink" title="什么是 go:embed"></a>什么是 go:embed</h3><p><code>//go:embed</code> 在 Go 1.16 版本中被加入，这也是我接触 Go 语言的第一个版本。</p>
<p><code>//go:embed</code> 是一个<strong>编译器指令</strong>，能够在程序编译时期在 Go 的二进制文件中嵌入<strong>任意文件和目录</strong>（除了少数 Go 官方限制不允许嵌入的指定类型文件或目录，后文会讲）。</p>
<p><code>//go:embed</code> 用法非常简单，示例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"embed"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> content <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> contentBytes []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> fileFS embed.FS</span><br><span class="line"><span class="keyword">var</span> data, _ = fileFS.ReadFile(<span class="string">"hello.txt"</span>)</span><br></pre></td></tr></table></figure>

<p>我们<strong>有且仅有 3 种方式</strong>可以将一个文件内容嵌入到 Go 变量中。</p>
<p>这 3 种方式各自适用场景如下：</p>
<ul>
<li><p>对于第 1 种用法，将文件嵌入到 <code>string</code> 中，适合嵌入单个文件（如配置数据、模板文件或一段文本）。</p>
</li>
<li><p>对于第 2 种用法，将文件嵌入到 <code>[]byte</code> 中，适合嵌入单个文件（如二进制文件：图片、字体或其他非文本数据）。</p>
</li>
<li><p>对于第 3 种用法，将文件嵌入到 <code>embed.FS</code> 中，适合嵌入多个文件或整个目录（<code>embed.FS</code> 是一个只读的虚拟文件系统）。</p>
</li>
</ul>
<p><code>//go:embed</code> 指令语法格式为：<code>//go:embed patterns</code>，其中 <code>patterns</code> 可以是文件名、目录名或 <code>path.Match</code> 所支持的路径通配符。</p>
<p>值得注意的是：<code>//go:embed</code> 指令仅接受相对于包含 Go 源文件的目录的路径，即当前程序源码所在目录，不能直接嵌入父目录文件内容（后文会讲解解决方案）。</p>
<p>并且，<code>//go:embed</code> 指令要紧挨着写在被嵌入文件的变量上面，类似注释，<code>//go:embed</code> 是固定写法，字符中间不能含有任何空格。比如 <code>// go:embed</code> 这种写法是不能被解析的。</p>
<p>此外，<code>//go:embed</code> 指令需要配合 <code>embed</code> 包一起使用。</p>
<h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><p>下面我们来通过一个示例程序，演示下 <code>//go:embed</code> 的使用。</p>
<p>准备如下项目目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tree -a getting-started</span><br><span class="line">getting-started</span><br><span class="line">├── file</span><br><span class="line">│   ├── hello1.txt</span><br><span class="line">│   ├── hello2.txt</span><br><span class="line">│   └── sub</span><br><span class="line">│       └── sub.txt</span><br><span class="line">├── go.mod</span><br><span class="line">├── hello.txt</span><br><span class="line">└── main.go</span><br><span class="line"></span><br><span class="line">3 directories, 6 files</span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 中编写示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"embed"</span></span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"io"</span></span><br><span class="line">	<span class="string">"io/fs"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> content <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed hello.txt</span></span><br><span class="line"><span class="keyword">var</span> contentBytes []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed file</span></span><br><span class="line"><span class="keyword">var</span> fileFS embed.FS</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed file/hello1.txt</span></span><br><span class="line"><span class="comment">//go:embed file/hello2.txt</span></span><br><span class="line"><span class="keyword">var</span> helloFS embed.FS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">"hello.txt content: %s\n"</span>, content)</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">"hello.txt content: %s\n"</span>, contentBytes)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> embed.FS 提供了 ReadFile 功能，可以直接读取文件内容，文件路径需要指明父目录 `file`</span></span><br><span class="line">	hello1Bytes, _ := fileFS.ReadFile(<span class="string">"file/hello1.txt"</span>)</span><br><span class="line">	fmt.Printf(<span class="string">"file/hello1.txt content: %s\n"</span>, hello1Bytes)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> embed.FS 提供了 ReadDir 功能，通过它可以遍历一个目录下的所有信息</span></span><br><span class="line">	dir, _ := fs.ReadDir(fileFS, <span class="string">"file"</span>)</span><br><span class="line">	<span class="keyword">for</span> _, entry := <span class="keyword">range</span> dir &#123;</span><br><span class="line">		info, _ := entry.Info()</span><br><span class="line">		fmt.Printf(<span class="string">"%+v\n"</span>, <span class="keyword">struct</span> &#123;</span><br><span class="line">			Name  <span class="keyword">string</span></span><br><span class="line">			IsDir <span class="keyword">bool</span></span><br><span class="line">			Info  <span class="keyword">struct</span> &#123;</span><br><span class="line">				Name <span class="keyword">string</span></span><br><span class="line">				Size <span class="keyword">int64</span></span><br><span class="line">				Mode fs.FileMode</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;&#123;</span><br><span class="line">			Name:  entry.Name(),</span><br><span class="line">			IsDir: entry.IsDir(),</span><br><span class="line">			Info: <span class="keyword">struct</span> &#123;</span><br><span class="line">				Name <span class="keyword">string</span></span><br><span class="line">				Size <span class="keyword">int64</span></span><br><span class="line">				Mode fs.FileMode</span><br><span class="line">			&#125;&#123;Name: info.Name(), Size: info.Size(), Mode: info.Mode()&#125;,</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> embed.FS 实现了 io/fs.FS 接口，可以返回它的子文件夹作为新的 io/fs.FS 文件系统</span></span><br><span class="line">	subFS, _ := fs.Sub(helloFS, <span class="string">"file"</span>)</span><br><span class="line">	hello2F, _ := subFS.Open(<span class="string">"hello2.txt"</span>)</span><br><span class="line">	hello2Bytes, _ := io.ReadAll(hello2F)</span><br><span class="line">	fmt.Printf(<span class="string">"file/hello2.txt content: %s\n"</span>, hello2Bytes)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例程序中，将 <code>hello.txt</code> 分别嵌入到 <code>content string</code>、<code>contentBytes []byte</code> 两个变量。</p>
<p>我们可以通过 <code>//go:embed 目录名</code> 的方式，将 <code>file</code> 目录嵌入到 <code>fileFS embed.FS</code> 文件系统。</p>
<p>对于 <code>embed.FS</code> 文件系统，我们可以连续写上多个 <code>//go:embed</code> 指令，来嵌入多个文件到 <code>helloFS embed.FS</code>。</p>
<p>并且，对于 <code>helloFS embed.FS</code> 这段代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:embed file/hello1.txt</span></span><br><span class="line"><span class="comment">//go:embed file/hello2.txt</span></span><br><span class="line"><span class="keyword">var</span> helloFS embed.FS</span><br></pre></td></tr></table></figure>

<p>还有另一种写法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:embed file/hello1.txt file/hello2.txt</span></span><br><span class="line"><span class="keyword">var</span> helloFS embed.FS</span><br></pre></td></tr></table></figure>

<p>二者等价。</p>
<p>在 <code>main</code> 函数中，首先对 <code>content string</code> 和 <code>contentBytes []byte</code> 的字符串格式内容进行了打印。</p>
<p>接着，使用 <code>embed.FS</code> 提供的 <code>ReadFile</code> 方法读取 <code>file/hello1.txt</code> 文件内容（注意：文件路径必须要指明父目录 <code>file</code>，否则会找不到 <code>hello1.txt</code> 文件）并打印。</p>
<p>此外，<code>embed.FS</code> 还提供了 <code>fs.ReadDir</code> 方法可以读取指定目录下所有文件信息。</p>
<p>最后，由于 <code>embed.FS</code> 实现了 <code>io/fs.FS</code> 接口，我们可以使用 <code>fs.Sub</code> 获取指定目录的子文件系统，然后就可以用 <code>subFS.Open(&quot;hello2.txt&quot;)</code> 方式直接读取 <code>hello2.txt</code> 内容（无需再指明父目录）并打印了。</p>
<p>执行示例代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">hello.txt content: Hello World!</span><br><span class="line">hello.txt content: Hello World!</span><br><span class="line">file/hello1.txt content: Hello1!</span><br><span class="line">&#123;Name:hello1.txt IsDir:<span class="literal">false</span> Info:&#123;Name:hello1.txt Size:7 Mode:-r--r--r--&#125;&#125;</span><br><span class="line">&#123;Name:hello2.txt IsDir:<span class="literal">false</span> Info:&#123;Name:hello2.txt Size:7 Mode:-r--r--r--&#125;&#125;</span><br><span class="line">&#123;Name:sub IsDir:<span class="literal">true</span> Info:&#123;Name:sub Size:0 Mode:dr-xr-xr-x&#125;&#125;</span><br><span class="line">file/hello2.txt content: Hello2!</span><br></pre></td></tr></table></figure>

<h3 id="在-HTTP-Server-中使用-go-embed"><a href="#在-HTTP-Server-中使用-go-embed" class="headerlink" title="在 HTTP Server 中使用 go:embed"></a>在 HTTP Server 中使用 go:embed</h3><p>由于 <code>//go:embed</code> 的核心功能就是将静态文件嵌入到 Go 程序中，所以 <code>//go:embed</code> 存在两个最常见的使用场景：一个是托管静态资源服务器，另一个是解决单元测试文件依赖问题。</p>
<p>我们先来看下 <code>//go:embed</code> 在静态资源服务中的应用。</p>
<p>准备如下项目目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ tree -a http</span><br><span class="line">http</span><br><span class="line">├── go.mod</span><br><span class="line">├── main.go</span><br><span class="line">├── static</span><br><span class="line">│   ├── css</span><br><span class="line">│   │   └── style.css</span><br><span class="line">│   ├── hello.txt</span><br><span class="line">│   ├── html</span><br><span class="line">│   │   └── index.html</span><br><span class="line">│   ├── img</span><br><span class="line">│   │   └── subscribe.jpeg</span><br><span class="line">│   └── js</span><br><span class="line">│       └── script.js</span><br><span class="line">└── template</span><br><span class="line">    └── email.tmpl</span><br><span class="line"></span><br><span class="line">7 directories, 8 files</span><br></pre></td></tr></table></figure>

<p>其中，<code>static</code> 是典型的静态资源目录，里面存储了前端三剑客 <code>HTML</code>、<code>CSS</code> 和 <code>JavaScript</code> 文件。内容分别如下：</p>
<blockquote>
<p><code>http/static/html/index.html</code>:</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"../css/style.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../js/script.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>关注我：Go编程世界<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../img/subscribe.jpeg"</span> <span class="attr">alt</span>=<span class="string">"Go编程世界"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>http/static/css/style.css</code>:</p>
</blockquote>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">h1</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#2c49a7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>http/static/js/script.js</code>:</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> body = <span class="built_in">document</span>.querySelector(<span class="string">"body"</span>)</span><br><span class="line">    body.style.background = <span class="string">"#f3f3f3"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>template</code> 是模板资源目录，使用 <code>Go template</code> 语法。<code>email.tmpl</code> 存储邮件模板，内容如下：</p>
<blockquote>
<p><code>http/template/email.tmpl</code>:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;pre&gt;</span><br><span class="line">    尊敬的用户：</span><br><span class="line">    </span><br><span class="line">    您好，欢迎您使用 XXX 服务！</span><br><span class="line">    </span><br><span class="line">    您的 XXX 账号是：&lt;b&gt;&#123;&#123; .Username &#125;&#125;&lt;&#x2F;b&gt;</span><br><span class="line">    请您点击下面的链接完成邮箱验证：</span><br><span class="line">    &lt;a href&#x3D;&quot;&#123;&#123; .ConfirmURL &#125;&#125;&quot;&gt;&#123;&#123; .ConfirmURL &#125;&#125;&lt;&#x2F;a&gt;</span><br><span class="line">    </span><br><span class="line">    若以上链接无法点击，请将该链接复制到浏览器（如 Chrome）的地址栏中访问。</span><br><span class="line">    </span><br><span class="line">    温馨提示：</span><br><span class="line">    1. 上述链接 24 小时内有效并且在激活过一次后失效。若验证链接失效，请登录网站 &lt;a href&#x3D;&quot;https:&#x2F;&#x2F;jianghushinian.cn&quot;&gt;https:&#x2F;&#x2F;jianghushinian.cn&lt;&#x2F;a&gt; 重新验证；</span><br><span class="line">    2. 如果您没有注册过 XXX 账号，请您忽略此邮件，由此给您带来的不便敬请谅解。</span><br><span class="line"></span><br><span class="line">  - 江湖十年</span><br><span class="line">    （这是一封自动产生的 Email，请勿回复）</span><br><span class="line">&lt;&#x2F;pre&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>main.go</code> 中编写示例代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"embed"</span></span><br><span class="line">	<span class="string">"io/fs"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"sync"</span></span><br><span class="line">	<span class="string">"text/template"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed static</span></span><br><span class="line"><span class="keyword">var</span> staticFS embed.FS</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed template</span></span><br><span class="line"><span class="keyword">var</span> templateFS embed.FS</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 在 go:embed 出现之前托管静态文件服务的写法</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		http.Handle(<span class="string">"/"</span>, http.FileServer(http.Dir(<span class="string">"static"</span>)))</span><br><span class="line">		_ = http.ListenAndServe(<span class="string">":8000"</span>, <span class="literal">nil</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 使用 go:embed 实现静态文件服务</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		_ = http.ListenAndServe(<span class="string">":8001"</span>, http.FileServer(http.FS(staticFS)))</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 可以使用 http.StripPrefix 去除静态文件服务的 `/static/` 路由前缀</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		http.Handle(<span class="string">"/static/"</span>, http.StripPrefix(<span class="string">"/static/"</span>, http.FileServer(http.FS(staticFS))))</span><br><span class="line">		_ = http.ListenAndServe(<span class="string">":8002"</span>, <span class="literal">nil</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 也可以使用 fs.Sub 去除静态文件服务的 `/static/` 路由前缀</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		fsSub, _ := fs.Sub(staticFS, <span class="string">"static"</span>)</span><br><span class="line">		_ = http.ListenAndServe(<span class="string">":8003"</span>, http.FileServer(http.FS(fsSub)))</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> text/template 和 html/template 同样可以从嵌入的文件系统中解析模板，这里以 text/template 为例</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		tmpl, _ := template.ParseFS(templateFS, <span class="string">"template/email.tmpl"</span>)</span><br><span class="line">		http.HandleFunc(<span class="string">"/email"</span>, <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</span><br><span class="line">			<span class="comment">// 设置 Content-Type 为 text/html</span></span><br><span class="line">			writer.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/html; charset=utf-8"</span>)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 执行模板并发送响应</span></span><br><span class="line">			_ = tmpl.ExecuteTemplate(writer, <span class="string">"email.tmpl"</span>, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">				<span class="string">"Username"</span>:   <span class="string">"江湖十年"</span>,</span><br><span class="line">				<span class="string">"ConfirmURL"</span>: <span class="string">"https://jianghushinian.cn"</span>,</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">		_ = http.ListenAndServe(<span class="string">":8004"</span>, <span class="literal">nil</span>)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用 <code>staticFS embed.FS</code> 和 <code>templateFS embed.FS</code> 分别嵌入静态文件和模版文件目录。</p>
<p>在 <code>main</code> 函数中，分别启动了 5 个 <code>goroutine</code>，用来对比演示使用 <code>//go:embed</code> 实现静态文件服务的效果。</p>
<p>第 1 个 <code>goroutine</code> 演示了在不使用 <code>//go:embed</code> 的情况下，我们如何来编写一个静态资源文件服务。可以直接使用 Go 在 <code>net/http</code> 中提供的 <code>http.FileServer</code> 将一整个目录作为静态资源目录。<code>http.FileServer</code> 返回一个 <code>http.Handler</code> 可以直接作为 Web Server 的 Handler 使用。这个服务监听 <code>8000</code> 端口。</p>
<p>第 2 个 <code>goroutine</code> 演示了如何使用 <code>//go:embed</code> 实现静态资源文件服务。因为 <code>http.FileServer</code> 参数接收 <code>http/fs.FileSystem</code> 类型，所以不能直接将 <code>embed.FS</code> 传递给它。<code>http/fs.FileSystem</code> 接口定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> FileSystem <span class="keyword">interface</span> &#123;</span><br><span class="line">	Open(name <span class="keyword">string</span>) (File, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前文说过 <code>embed.FS</code> 实现了 <code>io/fs.FS</code> 接口，刚好 <code>http</code> 提供了 <code>http.FS</code> 函数可以将 <code>io/fs.FS</code> 类型转换成 <code>http/fs.FileSystem</code>。<code>http.FS</code> 定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FS converts fsys to a [FileSystem] implementation,</span></span><br><span class="line"><span class="comment">// for use with [FileServer] and [NewFileTransport].</span></span><br><span class="line"><span class="comment">// The files provided by fsys must implement [io.Seeker].</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FS</span><span class="params">(fsys fs.FS)</span> <span class="title">FileSystem</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> ioFS&#123;fsys&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，我们能够非常方便的使用 <code>//go:embed</code> 来实现静态资源文件服务器。与第一种实现方式相比，这种方式在部署时更加简单，无需考虑静态资源目录依赖问题。</p>
<p>不过，使用 <code>//go:embed</code> 也引入了一个新问题，就是在我们访问 <code>/</code> 路由时，是不会直接显示 <code>static</code> 目录下内容的，而需要访问 <code>/static/</code> 路由才行。</p>
<p>要解决这个问题也很简单，可以使用 <code>http.StripPrefix</code> 去除静态文件服务的 <code>/static/</code> 路由前缀。</p>
<p>即第 3 个 <code>goroutine</code> 中的代码实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    http.Handle(<span class="string">"/static/"</span>, http.StripPrefix(<span class="string">"/static/"</span>, http.FileServer(http.FS(staticFS))))</span><br><span class="line">    _ = http.ListenAndServe(<span class="string">":8002"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>另外，我们也可以使用 <code>fs.Sub</code> 去除静态文件服务的 <code>/static/</code> 路由前缀。</p>
<p>即第 4 个 <code>goroutine</code> 中的代码实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    fsSub, _ := fs.Sub(staticFS, <span class="string">"static"</span>)</span><br><span class="line">    _ = http.ListenAndServe(<span class="string">":8003"</span>, http.FileServer(http.FS(fsSub)))</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>最后，第 5 个 <code>goroutine</code> 中使用 <code>template.ParseFS(templateFS, &quot;template/email.tmpl&quot;)</code> 来解析邮件模板。之所以 <code>template.ParseFS</code> 函数能直接解析 <code>embed.FS</code> 类型变量，同样是因为 <code>embed.FS</code> 实现了 <code>io/fs.FS</code> 接口。</p>
<p>我们来执行下示例程序，看下效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br></pre></td></tr></table></figure>

<p>浏览器中访问 <code>http://127.0.0.1:8000/</code> 效果如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="static.png" alt=":8000" title="">
                </div>
                <div class="image-caption">:8000</div>
            </figure>

<p>访问 <code>http://127.0.0.1:8001/static/</code> 效果如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="embed-static.png" alt=":8001" title="">
                </div>
                <div class="image-caption">:8001</div>
            </figure>

<p>访问 <code>http://127.0.0.1:8002/</code> 和 <code>http://127.0.0.1:8003/</code> 的效果，与访问 <code>http://127.0.0.1:8000/</code> 效果相同，你可以自行尝试。</p>
<p>访问 <code>http://127.0.0.1:8004</code> 效果如下：</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="email.png" alt=":8004" title="">
                </div>
                <div class="image-caption">:8004</div>
            </figure>

<p>其实这两种用法在 <code>embed</code> 的 <code>go doc</code> 中也能看到示例。</p>
<p>执行 <code>go doc embed</code> 命令，能在文档中找到如下内容：</p>
<blockquote>
<p>For example, given the content variable in the example above, we can write:</p>
<p>   http.Handle(“/static/“, http.StripPrefix(“/static/“, http.FileServer(http.FS(content))))</p>
<p>   template.ParseFS(content, “*.tmpl”)</p>
</blockquote>
<h3 id="在单元测试中使用-go-embed"><a href="#在单元测试中使用-go-embed" class="headerlink" title="在单元测试中使用 go:embed"></a>在单元测试中使用 go:embed</h3><p>现在我们来介绍下在单元测试场景中如何使用 <code>//go:embed</code>。</p>
<p>准备如下项目目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tree -a <span class="built_in">test</span> </span><br><span class="line"><span class="built_in">test</span></span><br><span class="line">├── go.mod</span><br><span class="line">├── main.go</span><br><span class="line">├── main_test.go</span><br><span class="line">├── main_x_test.go</span><br><span class="line">└── testdata</span><br><span class="line">    └── test.txt</span><br><span class="line"></span><br><span class="line">2 directories, 5 files</span><br></pre></td></tr></table></figure>

<p>这个示例程序中 <code>main.go</code> 代码并不重要，只要保证程序编译通过即可。</p>
<p><code>main_test.go</code> 代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	_ <span class="string">"embed"</span></span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed testdata/test.txt</span></span><br><span class="line"><span class="keyword">var</span> testF <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEmbed</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	t.Log(testF)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，其实在单元测试中，<code>//go:embed</code> 的用法并没什么两样。</p>
<p>不过在单元测试中，测试依赖的静态文件通常放到 <code>testdata</code> 目录下，这是约定俗成的做法。</p>
<p><strong>值得注意的是，示例代码中使用了匿名导入 <code>import _ &quot;embed&quot;</code>，<code>//go:embed</code> 指令使用时必须要配合 <code>embed</code> 包一起使用，否则执行程序将得到 <code>go:embed only allowed in Go files that import &quot;embed&quot;</code> 报错。</strong></p>
<p><code>main_x_test.go</code> 文件是黑盒测试文件，其包名为 <code>main_test</code>，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main_test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	_ <span class="string">"embed"</span></span><br><span class="line">	<span class="string">"testing"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed testdata/test.txt</span></span><br><span class="line"><span class="keyword">var</span> testF <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEmbed</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	t.Log(testF)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行测试代码，输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> -v                          </span><br><span class="line">=== RUN   TestEmbed</span><br><span class="line">    main_test.go:12: <span class="built_in">test</span> content</span><br><span class="line">--- PASS: TestEmbed (0.00s)</span><br><span class="line">=== RUN   TestEmbed</span><br><span class="line">    main_x_test.go:12: <span class="built_in">test</span> content</span><br><span class="line">--- PASS: TestEmbed (0.00s)</span><br><span class="line">PASS</span><br><span class="line">ok      github.com/jianghushinian/blog-go-example/embed/<span class="built_in">test</span>    0.505s</span><br></pre></td></tr></table></figure>

<p>顺便提一下，为了支持分析 Go 包的工具，通过 <code>//go:embed</code> 指令嵌入的目录或文件可以在 <code>go list</code> 输出中找到。</p>
<blockquote>
<p>NOTE: <code>go list</code> 命令是一个强大的工具，用于列出当前模块中的包或者查询包的特定属性。此命令可以显示关于包的详细信息，这些信息对于理解包的结构和依赖非常有用。</p>
</blockquote>
<p>执行 <code>go help list</code> 命令，可以在输出中找到如下几条信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Embedded files</span><br><span class="line">EmbedPatterns      []string &#x2F;&#x2F; &#x2F;&#x2F;go:embed patterns</span><br><span class="line">EmbedFiles         []string &#x2F;&#x2F; files matched by EmbedPatterns</span><br><span class="line">TestEmbedPatterns  []string &#x2F;&#x2F; &#x2F;&#x2F;go:embed patterns in TestGoFiles</span><br><span class="line">TestEmbedFiles     []string &#x2F;&#x2F; files matched by TestEmbedPatterns</span><br><span class="line">XTestEmbedPatterns []string &#x2F;&#x2F; &#x2F;&#x2F;go:embed patterns in XTestGoFiles</span><br><span class="line">XTestEmbedFiles    []string &#x2F;&#x2F; files matched by XTestEmbedPatterns</span><br></pre></td></tr></table></figure>

<p>对应用法和输出信息如下所示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 所有被直接嵌入的 patterns，包括目录和文件</span></span><br><span class="line">$ go list -f <span class="string">'&#123;&#123;.EmbedPatterns&#125;&#125;'</span></span><br><span class="line">[testdata]</span><br><span class="line"><span class="comment"># 嵌入的文件</span></span><br><span class="line">$ go list -f <span class="string">'&#123;&#123;.EmbedFiles&#125;&#125;'</span>   </span><br><span class="line">[testdata/test.txt]</span><br><span class="line"><span class="comment"># 测试文件中嵌入的 patterns</span></span><br><span class="line">$ go list -f <span class="string">'&#123;&#123;.TestEmbedPatterns&#125;&#125;'</span> </span><br><span class="line">[testdata/test.txt]</span><br><span class="line"><span class="comment"># 黑盒测试文件中嵌入的 patterns</span></span><br><span class="line">$ go list -f <span class="string">'&#123;&#123;.XTestEmbedPatterns&#125;&#125;'</span></span><br><span class="line">[testdata/test.txt]</span><br></pre></td></tr></table></figure>

<p>也可以以 JSON 格式输出以上信息：<code>go list -json</code>。</p>
<p>这里仅演示了在测试文件中使用 <code>//go:embed</code> 的简单用法，并不是真实案例。你可以在我另一篇文章：<a href="https://jianghushinian.cn/2023/07/19/how-to-resolve-file-dependencies-in-go-testing/" target="_blank" rel="noopener">《在 Go 语言单元测试中如何解决文件依赖问题》</a>，中找到单元测中使用 <code>//go:embed</code> 的真实案例，并详细讲解了如何使用 <code>//go:embed</code> 解决测试依赖。</p>
<h3 id="使用-go-embed-嵌入父目录"><a href="#使用-go-embed-嵌入父目录" class="headerlink" title="使用 go:embed 嵌入父目录"></a>使用 go:embed 嵌入父目录</h3><p>前文有提到：<code>//go:embed</code> 指令仅接受相对于包含 Go 源文件的目录的路径，即当前程序源码所在目录，不能直接嵌入父目录文件内容。</p>
<p>现在来讲解下如何解决这个问题。</p>
<p>准备如下项目目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tree -a parent-directory</span><br><span class="line">parent-directory</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── internal</span><br><span class="line">│   └── controller</span><br><span class="line">│       └── controller.go</span><br><span class="line">├── main.go</span><br><span class="line">└── template</span><br><span class="line">    └── email.tmpl</span><br><span class="line"></span><br><span class="line">4 directories, 5 files</span><br></pre></td></tr></table></figure>

<p>这是一个微型的 Web Server 程序，<code>main.go</code> 是程序入口，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/jianghushinian/blog-go-example/embed/parent-directory/internal/controller"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	r := gin.Default()</span><br><span class="line">	r.POST(<span class="string">"/users"</span>, (&amp;controller.Controller&#123;&#125;).CreateUser)</span><br><span class="line">	_ = r.Run(<span class="string">":8005"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例程序提供了一个 <code>创建用户</code> 的接口，并监听 <code>8005</code> 端口。</p>
<p><code>template/email.tmpl</code> 是邮件模板，内容与前文介绍的一样。</p>
<p><code>controller.go</code> 中代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"bytes"</span></span><br><span class="line">	<span class="string">"embed"</span></span><br><span class="line">	<span class="string">"net/http"</span></span><br><span class="line">	<span class="string">"text/template"</span></span><br><span class="line"></span><br><span class="line">	<span class="string">"github.com/gin-gonic/gin"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接嵌入父目录</span></span><br><span class="line"><span class="comment">//go:embed ../../template</span></span><br><span class="line"><span class="keyword">var</span> templateFS embed.FS</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Controller <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *Controller)</span> <span class="title">CreateUser</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">// pretend to create user ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// send email</span></span><br><span class="line">	tmpl, _ := template.ParseFS(templateFS, <span class="string">"template/*.tmpl"</span>)</span><br><span class="line">	<span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">	_ = tmpl.ExecuteTemplate(&amp;buf, <span class="string">"email.tmpl"</span>, <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line">		<span class="string">"Username"</span>:   <span class="string">"江湖十年"</span>,</span><br><span class="line">		<span class="string">"ConfirmURL"</span>: <span class="string">"https://jianghushinian.cn"</span>,</span><br><span class="line">	&#125;)</span><br><span class="line">	c.Data(http.StatusOK, <span class="string">"text/html; charset=utf-8"</span>, buf.Bytes())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CreateUser</code> 方法模拟实现了创建用户并返回邮件的逻辑。</p>
<p>示例代码中，我们尝试直接使用 <code>//go:embed ../../template</code> 来嵌入模版文件到变量 <code>templateFS embed.FS</code> 中。</p>
<p>执行示例代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">internal/controller/controller.go:13:12: pattern ../../template: invalid pattern syntax</span><br></pre></td></tr></table></figure>

<p>可以发现，程序直接报错了。</p>
<p>我在 <a href="https://github.com/golang/go/issues/46056" target="_blank" rel="noopener">issues/46056</a> 中找到了这个问题的解决方案。</p>
<p><a href="https://github.com/golang/go/issues/46056#issuecomment-938251415" target="_blank" rel="noopener">korya</a> 提供了一种思路：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:generate cp -r ../../assets ./local-asset-dir</span></span><br><span class="line"><span class="comment">//go:embed local-asset-dir</span></span><br><span class="line"><span class="keyword">var</span> assetFs embed.FS</span><br></pre></td></tr></table></figure>

<p>我们可以使用 <code>//go:generate</code> + <code>//go:embed</code> 的方式来解决此问题。</p>
<p><code>//go:generate</code> 是一个用于自动化生成 Go 代码的指令。 在执行程序之前，可以通过 <code>go generate</code>​ 命令自动执行 <code>//go:generate</code> 指令。</p>
<p>所以这个解决问题的思路是：在执行主程序前，先通过 <code>//go:generate</code> 将父目录所有文件拷贝到当前目录，然后再将当前目录中的文件嵌入 Go 程序。</p>
<p>这个思路可行，但不是一个好的解决方案：</p>
<ol>
<li><p>这样做相当于代码中存储了两份依赖文件。</p>
</li>
<li><p>我们很容易忘记执行 <code>go generate</code> 命令。</p>
</li>
</ol>
<p>我们确实还有更好的选择。</p>
<p>既然 <code>//go:embed</code> 不支持父目录，那么我们可以换个角度，在 <code>template</code> 目录下新建一个 Go 文件来嵌入模板文件 <code>email.tmpl</code>，这样就变成了从当前目录嵌入文件。然后在使用时，导入 <code>template</code> 目录下 Go 文件中嵌入静态文件的变量即可。</p>
<p>新建 <code>template/template.go</code> 文件，代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> template</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"embed"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//go:embed *</span></span><br><span class="line"><span class="keyword">var</span> TemplateFS embed.FS</span><br></pre></td></tr></table></figure>

<p><code>//go:embed</code> 的 <code>patterns</code> 参数不仅不支持 <code>..</code> 这种父目录写法，表示当前目录的 <code>.</code> 写法也不支持。不过我们可以使用 <code>*</code> 来嵌入当前目录下的所有文件。</p>
<p>因为 <code>TemplateFS</code> 变量需要被外部引用，所以首字母大写，作为可导出变量。由此可见，<code>//go:embed</code> 可以将文件嵌入为 <code>exported</code> 的变量，也可以嵌入为 <code>unexported</code> 的变量。</p>
<p>现在对 <code>controller.go</code> 文件内容做如下修改：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> controller</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	...</span><br><span class="line">	templatefs <span class="string">"github.com/jianghushinian/blog-go-example/embed/parent-directory/template"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(ctrl *Controller)</span> <span class="title">CreateUser</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">	<span class="comment">// pretend to create user ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// send email</span></span><br><span class="line">	tmpl, _ := template.ParseFS(templatefs.TemplateFS, <span class="string">"*.tmpl"</span>) <span class="comment">// 记得去掉 template 前缀</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重新执行程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line">[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><br><span class="line"></span><br><span class="line">[GIN-debug] [WARNING] Running <span class="keyword">in</span> <span class="string">"debug"</span> mode. Switch to <span class="string">"release"</span> mode <span class="keyword">in</span> production.</span><br><span class="line"> - using env:   <span class="built_in">export</span> GIN_MODE=release</span><br><span class="line"> - using code:  gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] POST   /users                    --&gt; github.com/jianghushinian/blog-go-example/embed/parent-directory/internal/controller.(*Controller).CreateUser-fm (3 handlers)</span><br><span class="line">[GIN-debug] [WARNING] You trusted all proxies, this is NOT safe. We recommend you to <span class="built_in">set</span> a value.</span><br><span class="line">Please check https://pkg.go.dev/github.com/gin-gonic/gin<span class="comment">#readme-don-t-trust-all-proxies for details.</span></span><br><span class="line">[GIN-debug] Listening and serving HTTP on :8005</span><br></pre></td></tr></table></figure>

<p>根据输出的日志信息可知，Web Server 已经成功启动了。</p>
<p>使用 <code>curl</code> 来创建一个用户看看效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X POST http://127.0.0.1:8005/users</span><br><span class="line">&lt;pre&gt;</span><br><span class="line">    尊敬的用户：</span><br><span class="line"></span><br><span class="line">    您好，欢迎您使用 XXX 服务！</span><br><span class="line"></span><br><span class="line">    您的 XXX 账号是：&lt;b&gt;江湖十年&lt;/b&gt;</span><br><span class="line">    请您点击下面的链接完成邮箱验证：</span><br><span class="line">    &lt;a href=<span class="string">"https://jianghushinian.cn"</span>&gt;https://jianghushinian.cn&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">    若以上链接无法点击，请将该链接复制到浏览器（如 Chrome）的地址栏中访问。</span><br><span class="line"></span><br><span class="line">    温馨提示：</span><br><span class="line">    1. 上述链接 24 小时内有效并且在激活过一次后失效。若验证链接失效，请登录网站 &lt;a href=<span class="string">"https://jianghushinian.cn"</span>&gt;https://jianghushinian.cn&lt;/a&gt; 重新验证；</span><br><span class="line">    2. 如果您没有注册过 XXX 账号，请您忽略此邮件，由此给您带来的不便敬请谅解。</span><br><span class="line"></span><br><span class="line">  - 江湖十年</span><br><span class="line">    （这是一封自动产生的 Email，请勿回复）</span><br><span class="line">&lt;/pre&gt;</span><br></pre></td></tr></table></figure>

<p>至此，使用 <code>//go:embed</code> 嵌入父目录的问题已经被我们解决了。</p>
<h3 id="使用-go-embed-的注意事项"><a href="#使用-go-embed-的注意事项" class="headerlink" title="使用 go:embed 的注意事项"></a>使用 go:embed 的注意事项</h3><p>我们已经介绍了 <code>//go:embed</code> 的常见用法。不过还有一些注意事项值得讨论。</p>
<h4 id="安全性"><a href="#安全性" class="headerlink" title="安全性"></a>安全性</h4><p>我们知道 <code>//go:embed</code> 能够将文件或目录嵌入到 3 种类型变量中，分别是 <code>string</code>、<code>[]byte</code> 和 <code>embed.FS</code>。其中 <code>string</code> 是 Go 语言本身限制为只读，而 <code>[]byte</code> 是可以修改的，所以使用时需要注意这一点。对于 <code>embed.FS</code>，其为只读(<code>read-only</code>)集合，是故意这么设计的。如果声明中没有 <code>//go:embed</code> 指令对其进行初始化，那么 <code>embed.FS</code> 就是一个空文件系统。正因为 <code>embed.FS</code> 是一个只读的值，因此它是并发安全的，你可以尽情的在多个 <code>goroutine</code> 中使用它。</p>
<h4 id="patterns-规则"><a href="#patterns-规则" class="headerlink" title="patterns 规则"></a><code>patterns</code> 规则</h4><p><code>//go:embed patterns</code> 指令的 <code>patterns</code> 参数，不支持嵌入空目录，并且也不支持嵌入符号链接（<code>symbolic links</code>），即软链接。也不能匹配一些特殊符号：<code>&quot; * &lt; &gt; ? ` &#39; | / \</code>。</p>
<p>根据前文的示例程序，<code>patterns</code> 指定为目录时，该目录下的所有文件都会被嵌入到变量中。但是以 <code>.</code> 或 <code>_</code> 开头的文件是会被忽略的。如果想要嵌入 <code>.</code> 或 <code>_</code> 开头的文件，可以让 <code>patterns</code> 以 <code>all:</code> 前缀开头，如 <code>//go:embed all:testdata</code>。也可以使用通配符 <code>*</code>，如 <code>//go:embed testdata/*</code>，不过 <code>*</code> 不具有递归性，子目录下的 <code>.</code> 或 <code>_</code> 开头文件不会被嵌入。</p>
<p>比如：</p>
<ul>
<li><p><code>image</code> 不会嵌入 <code>image/.tempfile</code> 文件。</p>
</li>
<li><p><code>image/*</code> 会嵌入 <code>image/.tempfile</code> 文件。</p>
</li>
<li><p>以上二者都不会嵌入 <code>image/dir/.tempfile</code>。</p>
</li>
<li><p><code>all:image</code> 则会同时嵌入 <code>image/.tempfile</code> 和 <code>image/dir/.tempfile</code> 两个文件。</p>
</li>
</ul>
<p>注意，使用 <code>//go:embed</code> 嵌入带有路径的文件时，目录分隔符采用正斜杠 <code>/</code>，如 <code>//go:embed file/hello1.txt</code>，即使是 Windows 系统也是如此。</p>
<p><code>patterns</code> 支持使用双引号 <code>&quot;</code> 或者反引号 <code>`</code> 的方式应用到嵌入的文件名、目录名或者 <code>pattern</code> 上，这对名称中带有 <code>空格</code> 或 <code>特殊字符</code> 很有用。</p>
<p>此外，诸如 <code>.bzr</code>、<code>.hg</code>、<code>.git</code>、<code>.svn</code> 这几个版本控制管理目录，始终都不会被嵌入，<code>embed</code> 相关代码中会做检查。</p>
<p>不要在 <code>patterns</code> 路径中包含特殊字符，比如 <code>-</code>、<code>$</code> 等。不然，根据我的实测结果，你将得到类似 <code>imports embed/testdata: invalid input file name &quot;$not-hidden/fortune.txt&quot;</code> 报错信息。</p>
<h4 id="path-Match"><a href="#path-Match" class="headerlink" title="path.Match"></a>path.Match</h4><p><code>patterns</code> 支持文件名、目录名以及 <code>path.Match</code> 所支持的路径通配符。</p>
<p>对于 <code>path.Match</code> 我来更详细的讲解下。</p>
<p><code>path.Match</code> 函数签名如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Match</span><span class="params">(pattern, name <span class="keyword">string</span>)</span> <span class="params">(matched <span class="keyword">bool</span>, err error)</span></span></span><br></pre></td></tr></table></figure>

<p>对于匹配 <code>path.Match</code> 规则如下：</p>
<p><strong>功能说明</strong></p>
<ul>
<li><p><code>path.Match</code> 函数的功能是：报告参数 <code>name</code> 是否符合指定的 shell 模式（<code>pattern</code>）。</p>
</li>
<li><p>这个函数要求模式与整个 <code>name</code> 完全匹配，而不是仅匹配其中的一个子串。</p>
</li>
</ul>
<p><strong>模式语法</strong></p>
<ul>
<li><p><strong>pattern</strong>：由一个或多个 <code>term</code> 构成。</p>
</li>
<li><p><strong>term</strong>：可以是以下几种类型：</p>
<ul>
<li><code>*</code> 匹配任意序列的非<code>/</code>字符。</li>
<li><code>?</code> 匹配任意单个非<code>/</code>字符。</li>
<li><code>[character-range]</code> 定义一个字符类，必须是非空的。在字符类内部，如果以 <code>^</code> 开头（<code>[^character-range]</code>），则表示取反，否定后续的字符范围。</li>
<li>单个字符 <code>c</code>，可以直接匹配字符 <code>c</code>（当 <code>c</code> 不是 <code>*</code>、<code>?</code>、<code>\</code>、<code>[</code> 中的一个时）。</li>
<li><code>\\c</code> 用于转义匹配字符 <code>c</code>，<code>\\</code> 用于转义（例如 <code>\\</code>、<code>\*</code>、<code>\?</code> 等）。 </li>
</ul>
</li>
<li><p><strong>character-range</strong>：</p>
<ul>
<li>单个字符 <code>c</code>，直接匹配字符 <code>c</code>（当 <code>c</code> 不是 <code>\\</code>、<code>-</code>、<code>]</code> 中的一个时）。</li>
<li><code>\\c</code> 用于转义匹配字符 <code>c</code>。</li>
<li><code>lo-hi</code> 匹配从 <code>lo</code> 到 <code>hi</code> 之间的任意字符（包括 <code>lo</code> 和 <code>hi</code>）。</li>
</ul>
</li>
</ul>
<h4 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h4><p><code>//go:embed</code> 指令只能用在包一级的全局变量中，不能用在函数或方法级别。</p>
<p>这个问题在 <a href="https://github.com/golang/go/issues/43216" target="_blank" rel="noopener">issues/43216</a> 中有讨论。</p>
<p>大致原因如下：</p>
<ul>
<li><p>如果嵌入资源只初始化一次，那么每次函数调用都将共享这些资源，考虑到任何函数都可以作为 <code>goroutine</code> 运行，这会带来严重的潜在风险；</p>
</li>
<li><p>如果每次函数调用时都重新初始化，这样做会产生额外的性能开销。</p>
</li>
</ul>
<p>虽然 <code>//go:embed</code> 在设计之初是支持函数或方法级别变量的，但基于以上两点考虑，最终这个功能被移除了。</p>
<p>由于以上这些注意事项过于琐碎，我就不一一举例说明了，你可以自行尝试，也可以先跳过，等遇到问题了再过来查找原因。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在 Go 1.16 版本发布时加入了 <code>//go:embed</code> 指令。</p>
<p><code>//go:embed</code> 是一个编译器指令，能够在程序编译时期在 Go 的二进制文件中嵌入任意文件和目录。这使得在 Go 文件中嵌入静态资源变得异常简单而直接。</p>
<p><code>//go:embed</code> 语法非常简单：<code>//go:embed patterns</code>。<code>//go:embed</code> 能够将文件或目录分别嵌入到 <code>string</code>、<code>[]byte</code> 和 <code>embed.FS</code> 3 中类型变量中。</p>
<p><code>//go:embed</code> 最常见的两个使用场景分别时：托管静态资源服务器，和解决单元测试文件依赖问题。</p>
<p>我们可以在静态文件目录下创建一个 Go 文件，然后使用 <code>//go:embed *</code> 将静态文件嵌入进来，然后在使用时，导入静态文件目录下 Go 文件中嵌入静态文件的变量。这样可以实现嵌入 Go 源文件的父目录内容。</p>
<p><code>//go:embed</code> 还有很多使用细节值得注意：比如在考虑安全性时需要顾及被嵌入静态文件的变量是否可变；<code>patterns</code> 中不能随意包含特殊字符；和当 <code>pattern</code> 为 <code>path.Match</code> 时的语法规范等。</p>
<p><code>//go:embed</code> 指令只能用在包一级的全局变量中，不能用在函数或方法级别。</p>
<p>此外，在 <code>embed</code> 的测试文件 <a href="https://github.com/golang/go/blob/go1.22.0/src/embed/internal/embedtest/embed_test.go" target="_blank" rel="noopener">源码</a> 中，有一些写法我们也可以作为参考。</p>
<p>本文示例源码我都放在了 <a href="https://github.com/jianghushinian/blog-go-example/tree/main/embed" target="_blank" rel="noopener">GitHub</a> 中，欢迎点击查看。</p>
<p>希望此文能对你有所启发。</p>
<p><strong>延伸阅读</strong></p>
<ul>
<li>embed Documentation: <a href="https://pkg.go.dev/embed@go1.22.0" target="_blank" rel="noopener">https://pkg.go.dev/embed@go1.22.0</a></li>
<li>Go 1.16 Release Notes: <a href="https://go.dev/doc/go1.16#library-embed" target="_blank" rel="noopener">https://go.dev/doc/go1.16#library-embed</a></li>
<li>issues/46056: <a href="https://github.com/golang/go/issues/46056" target="_blank" rel="noopener">https://github.com/golang/go/issues/46056</a></li>
<li>issues/43216: <a href="https://github.com/golang/go/issues/43216" target="_blank" rel="noopener">https://github.com/golang/go/issues/43216</a></li>
<li>path.Match Documentation: <a href="https://pkg.go.dev/path@go1.22.0#Match" target="_blank" rel="noopener">https://pkg.go.dev/path@go1.22.0#Match</a></li>
<li>embed test: <a href="https://github.com/golang/go/blob/go1.22.0/src/embed/internal/embedtest/embed_test.go" target="_blank" rel="noopener">https://github.com/golang/go/blob/go1.22.0/src/embed/internal/embedtest/embed_test.go</a></li>
<li>Go by Example: Embed Directive: <a href="https://gobyexample.com/embed-directive" target="_blank" rel="noopener">https://gobyexample.com/embed-directive</a></li>
<li>Go command support for embedded static assets (files) — Draft Design: <a href="https://go.googlesource.com/proposal/+/master/design/draft-embed.md" target="_blank" rel="noopener">https://go.googlesource.com/proposal/+/master/design/draft-embed.md</a></li>
<li>Working with Embed in Go 1.16 Version: <a href="https://lakefs.io/blog/working-with-embed-in-go/" target="_blank" rel="noopener">https://lakefs.io/blog/working-with-embed-in-go/</a></li>
<li>How to use go:embed in Golang: <a href="https://www.educative.io/answers/how-to-use-goembed-in-golang" target="_blank" rel="noopener">https://www.educative.io/answers/how-to-use-goembed-in-golang</a></li>
<li>在 Go 语言单元测试中如何解决文件依赖问题: <a href="https://jianghushinian.cn/2023/07/19/how-to-resolve-file-dependencies-in-go-testing/" target="_blank" rel="noopener">https://jianghushinian.cn/2023/07/19/how-to-resolve-file-dependencies-in-go-testing/</a></li>
<li>本文 GitHub 示例代码：<a href="https://github.com/jianghushinian/blog-go-example/tree/main/embed" target="_blank" rel="noopener">https://github.com/jianghushinian/blog-go-example/tree/main/embed</a></li>
</ul>
<p><strong>联系我</strong></p>
<ul>
<li>公众号：<a href="https://jianghushinian.cn/about" target="_blank" rel="noopener">Go编程世界</a></li>
<li>微信：jianghushinian</li>
<li>邮箱：<a href="mailto:jianghushinian007@outlook.com">jianghushinian007@outlook.com</a></li>
<li>博客：<a href="https://jianghushinian.cn" target="_blank" rel="noopener">https://jianghushinian.cn</a></li>
</ul>

        </div>

        <blockquote class="post-copyright">
    
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2024-07-14T16:13:52.915Z" itemprop="dateUpdated">2024-07-15 00:13:52</time>
</span><br>


        
        <a href="/2024/07/12/go-embed/" target="_blank" rel="external">http://www.jianghushinian.cn/2024/07/12/go-embed/</a>
        
    </div>
    
    <footer>
        <a href="http://www.jianghushinian.cn">
            <img src="/img/avatar.png" alt="江湖十年">
            江湖十年
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/" rel="tag">Go</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.jianghushinian.cn/2024/07/12/go-embed/&title=《在 Go 中如何使用 go:embed 指令嵌入静态文件》 — 江湖十年&pic=http://www.jianghushinian.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.jianghushinian.cn/2024/07/12/go-embed/&title=《在 Go 中如何使用 go:embed 指令嵌入静态文件》 — 江湖十年&source=有时候，将配置文件、模板甚至整个前端应用直接嵌入到 Go 二进制文件中，是一种提高应用部署效率和简化操作的有效方法。自从 Go 1.16 版本起，Go 语..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.jianghushinian.cn/2024/07/12/go-embed/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《在 Go 中如何使用 go:embed 指令嵌入静态文件》 — 江湖十年&url=http://www.jianghushinian.cn/2024/07/12/go-embed/&via=http://www.jianghushinian.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.jianghushinian.cn/2024/07/12/go-embed/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/2024/07/20/chinese-copywriting-guidelines/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">中文文案排版指北</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/2024/07/07/do-you-understand-the-memory-alignment-of-structs-in-the-go/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Go 语言中的结构体内存对齐你了解吗？</h4>
      </a>
    </div>
  
</nav>



    


    <script src="/js/md5.min.js"></script>
    <section class="comments" id="comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'https-jianghushinian-cn';
            var disqus_identifier = location.pathname.slice(1,);
            var disqus_url = 'https://jianghushinian.cn/' + disqus_identifier;
            (function () {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the comments.</noscript>
    </section>


















</article>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        <span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        <span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>博客内容遵循 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p><span>江湖十年 &copy; 2019 - 2025</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.jianghushinian.cn/2024/07/12/go-embed/&title=《在 Go 中如何使用 go:embed 指令嵌入静态文件》 — 江湖十年&pic=http://www.jianghushinian.cn/img/avatar.png" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.jianghushinian.cn/2024/07/12/go-embed/&title=《在 Go 中如何使用 go:embed 指令嵌入静态文件》 — 江湖十年&source=有时候，将配置文件、模板甚至整个前端应用直接嵌入到 Go 二进制文件中，是一种提高应用部署效率和简化操作的有效方法。自从 Go 1.16 版本起，Go 语..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.jianghushinian.cn/2024/07/12/go-embed/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《在 Go 中如何使用 go:embed 指令嵌入静态文件》 — 江湖十年&url=http://www.jianghushinian.cn/2024/07/12/go-embed/&via=http://www.jianghushinian.cn" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.jianghushinian.cn/2024/07/12/go-embed/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://www.jianghushinian.cn/2024/07/12/go-embed/" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>






<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





</body>
</html>
